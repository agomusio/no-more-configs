name: Create Release

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Extract release notes from CHANGELOG
        id: notes
        run: |
          version="${{ steps.version.outputs.version }}"
          notes=$(awk "/^## \[$version\]/{found=1; next} found && /^## \[/{exit} found{print}" CHANGELOG.md \
            | sed '/./,$!d' | sed -e :a -e '/^\n*$/{$d;N;ba}')
          {
            echo "notes<<EOF"
            echo "$notes"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create GitHub release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ github.ref_name }}" \
            --title "${{ github.ref_name }} â€” $(date +%Y-%m-%d)" \
            --notes "${{ steps.notes.outputs.notes }}"
