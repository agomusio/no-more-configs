---
phase: 01-configuration-consolidation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - .devcontainer/install-agent-config.sh
  - .devcontainer/devcontainer.json
must_haves:
  truths:
    - "install-agent-config.sh reads config.json and secrets.json, extracts values with jq, and generates ~/.claude/settings.local.json from the settings template"
    - "install-agent-config.sh restores Claude credentials from secrets.json to ~/.claude/.credentials.json when present"
    - "install-agent-config.sh generates .mcp.json from enabled MCP templates in config.json"
    - "install-agent-config.sh installs GSD framework (29 commands + 11 agents) and creates ~/.claude/agents/"
    - "install-agent-config.sh runs successfully when config.json is missing (uses defaults, prints warning)"
    - "install-agent-config.sh runs successfully when secrets.json is missing (uses empty placeholders, prints warnings)"
    - "install-agent-config.sh runs successfully when BOTH files are missing (zero-config mode)"
    - "install-agent-config.sh runs multiple times without creating duplicates or failing (natural idempotency)"
    - "install-agent-config.sh validates JSON syntax of config.json and secrets.json before processing"
    - "install-agent-config.sh prints [install]-prefixed summary listing what was installed and what is missing"
    - "devcontainer.json postCreateCommand calls install-agent-config.sh"
  artifacts:
    - path: ".devcontainer/install-agent-config.sh"
      provides: "Idempotent config hydration and agent setup script"
      min_lines: 80
    - path: ".devcontainer/devcontainer.json"
      provides: "Updated lifecycle hooks"
      contains: "install-agent-config.sh"
  key_links:
    - from: ".devcontainer/install-agent-config.sh"
      to: "config.json"
      via: "jq reads config values"
      pattern: "jq.*config\\.json"
    - from: ".devcontainer/install-agent-config.sh"
      to: "secrets.json"
      via: "jq reads secret values"
      pattern: "jq.*secrets"
    - from: ".devcontainer/install-agent-config.sh"
      to: "agent-config/settings.json.template"
      via: "sed replaces {{PLACEHOLDER}} tokens with extracted values"
      pattern: "sed.*LANGFUSE_HOST"
    - from: ".devcontainer/install-agent-config.sh"
      to: "agent-config/mcp-templates/"
      via: "reads enabled templates from config.json, hydrates placeholders"
      pattern: "mcp.templates"
    - from: ".devcontainer/devcontainer.json"
      to: ".devcontainer/install-agent-config.sh"
      via: "postCreateCommand lifecycle hook"
      pattern: "install-agent-config"
autonomous: true
---

<objective>
Create the install-agent-config.sh script that reads config.json + secrets.json, hydrates templates, installs GSD, restores credentials, and prints a summary. Then wire it into the devcontainer lifecycle.

Purpose: This is the core automation of Phase 1 — the script that turns the two master files into a working agent configuration. It must handle all degraded modes (missing config, missing secrets, both missing) gracefully.

Output: .devcontainer/install-agent-config.sh (the hydration script), updated .devcontainer/devcontainer.json (lifecycle hook).
</objective>

<execution_context>
@C:/Users/sam/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-configuration-consolidation/01-RESEARCH.md
@.planning/phase-1-CONTEXT.md
@.planning/phases/01-configuration-consolidation/01-01-SUMMARY.md
@.devcontainer/devcontainer.json
@.devcontainer/setup-container.sh
@.devcontainer/init-gsd.sh
@.devcontainer/mcp-setup-bin.sh
@config.json
@secrets.example.json
@agent-config/settings.json.template
@agent-config/mcp-templates/mcp-gateway.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create install-agent-config.sh</name>
  <files>.devcontainer/install-agent-config.sh</files>
  <action>
Create the install script at `.devcontainer/install-agent-config.sh`. This is the most important file in Phase 1. It must be:
- Idempotent (safe to run multiple times — no state markers, use mkdir -p, cp -r, heredoc regeneration)
- Gracefully degrading (works with missing config.json, missing secrets.json, or both missing)
- Using `set -euo pipefail` for error handling
- All output prefixed with `[install]` for grep in build logs

**Script structure (in order):**

```bash
#!/bin/bash
set -euo pipefail
```

**1. Constants and paths:**
```bash
WORKSPACE_ROOT="/workspace"
CONFIG_FILE="$WORKSPACE_ROOT/config.json"
SECRETS_FILE="$WORKSPACE_ROOT/secrets.json"
AGENT_CONFIG_DIR="$WORKSPACE_ROOT/agent-config"
CLAUDE_DIR="${CLAUDE_CONFIG_DIR:-/home/node/.claude}"
SETTINGS_TEMPLATE="$AGENT_CONFIG_DIR/settings.json.template"
MCP_TEMPLATES_DIR="$AGENT_CONFIG_DIR/mcp-templates"
```

**2. JSON validation helper function:**
```bash
validate_json() {
    local file="$1"
    local label="$2"
    if ! jq empty < "$file" &>/dev/null; then
        echo "[install] ERROR: $label is not valid JSON — skipping"
        return 1
    fi
    return 0
}
```

**3. Load config.json (or use defaults):**
- If file exists AND passes JSON validation: extract values with jq using `//` for defaults
- If file missing: use hardcoded defaults, print `[install] config.json not found — using defaults`
- Extract: `langfuse.host`, `firewall.extra_domains`, `mcp_servers` keys

Default values (when config.json missing):
- LANGFUSE_HOST: `http://host.docker.internal:3052`
- MCP_GATEWAY_URL: use `$MCP_GATEWAY_URL` env var or default to `http://host.docker.internal:8811`

**4. Load secrets.json (or use empty placeholders):**
- If file exists AND passes JSON validation: extract values with jq
- If file missing: use empty strings, print `[install] secrets.json not found — using empty placeholders`
- Extract: `langfuse.public_key`, `langfuse.secret_key`, `claude.credentials`
- For each missing secret value, print a specific warning: `[install] secrets.json: langfuse.secret_key missing — tracing will not work`

**5. Create directories (idempotent):**
```bash
mkdir -p "$CLAUDE_DIR/skills"
mkdir -p "$CLAUDE_DIR/hooks"
mkdir -p "$CLAUDE_DIR/agents"
mkdir -p "$CLAUDE_DIR/commands"
```

**6. Generate settings.local.json from template:**
- Read the template from `agent-config/settings.json.template`
- Replace `{{LANGFUSE_HOST}}` with extracted value from config.json
- Replace `{{LANGFUSE_PUBLIC_KEY}}` with extracted value from secrets.json
- Replace `{{LANGFUSE_SECRET_KEY}}` with extracted value from secrets.json
- Use `sed` for replacement: `sed -e "s|{{LANGFUSE_HOST}}|$LANGFUSE_HOST|g" -e "s|{{LANGFUSE_PUBLIC_KEY}}|$LANGFUSE_PUBLIC_KEY|g" -e "s|{{LANGFUSE_SECRET_KEY}}|$LANGFUSE_SECRET_KEY|g"`
- Write to `$CLAUDE_DIR/settings.local.json`
- Print: `[install] Generated settings.local.json`

**7. Restore Claude credentials (if available):**
- If secrets.json exists and `.claude.credentials` is not null/empty:
  - Extract `.claude.credentials` as raw JSON object
  - Write to `$CLAUDE_DIR/.credentials.json`
  - Set permissions: `chmod 600 "$CLAUDE_DIR/.credentials.json"`
  - Print: `[install] Claude credentials restored`
- If missing: print `[install] Claude credentials not found — manual login required after first start`

**8. Generate .mcp.json from enabled MCP templates:**
- Read config.json to find which MCP servers are enabled (`.mcp_servers | keys[]` where `.enabled == true`)
- For each enabled server, read the corresponding template from `agent-config/mcp-templates/{server-name}.json`
- Hydrate `{{MCP_GATEWAY_URL}}` placeholder with env var `$MCP_GATEWAY_URL` or default `http://host.docker.internal:8811`
- Combine all hydrated templates into a single `.mcp.json` at workspace root using jq: `{ "mcpServers": { ...merged... } }`
- If no templates found or config.json missing, generate default .mcp.json with just mcp-gateway (matching current mcp-setup-bin.sh behavior)
- Print: `[install] Generated .mcp.json with N server(s)`

**9. Install GSD framework:**
- Check if GSD commands already exist: `if [ -d "$CLAUDE_DIR/commands/gsd" ] && [ "$(ls -A "$CLAUDE_DIR/commands/gsd" 2>/dev/null)" ]`
- If not installed: run `npx get-shit-done-cc --claude --global`
- Count commands and agents for summary
- Print: `[install] GSD: N commands + M agents`

**10. Print summary:**
Print a final summary block:
```
[install] --- Summary ---
[install] Config: loaded (or "defaults — config.json not found")
[install] Secrets: loaded (or "empty placeholders — secrets.json not found")
[install] Settings: generated
[install] Credentials: restored (or "missing — manual login required")
[install] MCP: N server(s)
[install] GSD: N commands + M agents
[install] Done.
```

**Important notes:**
- Do NOT modify existing scripts (setup-container.sh, init-gsd.sh, mcp-setup-bin.sh) — install-agent-config.sh is a standalone addition per locked decision
- Use `|| true` or conditional blocks to prevent `set -e` from exiting on optional checks
- Use `jq -r` for raw string output (no quotes), `jq -e` for existence checks
- For credential restoration, verify the extracted value is a valid JSON object (not empty `{}` or `null`) before writing
- The script is meant to run as `postCreateCommand` (once on container creation), but must be safe to run manually at any time
  </action>
  <verify>
Run shellcheck if available: `shellcheck .devcontainer/install-agent-config.sh` (or `npx shellcheck .devcontainer/install-agent-config.sh`). Verify the script is executable-ready: `head -1 .devcontainer/install-agent-config.sh` should show `#!/bin/bash`. Verify key patterns exist in the script:
- `grep "set -euo pipefail" .devcontainer/install-agent-config.sh`
- `grep "jq.*config.json" .devcontainer/install-agent-config.sh`
- `grep "jq.*secrets" .devcontainer/install-agent-config.sh`
- `grep "LANGFUSE_HOST" .devcontainer/install-agent-config.sh`
- `grep "get-shit-done-cc" .devcontainer/install-agent-config.sh`
- `grep "\[install\]" .devcontainer/install-agent-config.sh`
- `grep "mkdir -p" .devcontainer/install-agent-config.sh`
- `grep "credentials" .devcontainer/install-agent-config.sh`
- `grep "settings.local.json" .devcontainer/install-agent-config.sh`
Verify the file has at least 80 lines: `wc -l .devcontainer/install-agent-config.sh`.
  </verify>
  <done>
install-agent-config.sh exists at .devcontainer/install-agent-config.sh. It reads config.json and secrets.json with jq (with defaults for missing files), validates JSON syntax, generates settings.local.json from the template, restores Claude credentials, generates .mcp.json from enabled MCP templates, installs GSD framework, and prints an [install]-prefixed summary. Script uses set -euo pipefail, mkdir -p for idempotency, and handles all degraded modes (no config, no secrets, neither).
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire install script into devcontainer lifecycle and update .gitignore</name>
  <files>.devcontainer/devcontainer.json</files>
  <action>
Update `.devcontainer/devcontainer.json` to call install-agent-config.sh during container creation.

**Modify postCreateCommand:**
The current value is: `"bash .devcontainer/setup-container.sh"`

Change to chain the install script AFTER the existing setup:
```json
"postCreateCommand": "bash .devcontainer/setup-container.sh && bash .devcontainer/install-agent-config.sh"
```

The install script runs after setup-container.sh because:
- setup-container.sh handles Docker socket permissions and git config (prerequisites)
- install-agent-config.sh handles config hydration and agent setup (depends on git being configured)

**Do NOT modify postStartCommand** — it stays as-is. The existing init-gsd.sh in postStartCommand provides a fallback check for GSD commands on every start, which is fine alongside the install script running on create. They are compatible because both use natural idempotency.

**Do NOT remove the ~/.claude bind mount** — that is Phase 3 scope. The install script will write to ~/.claude which is currently bind-mounted. This means the generated files will appear on the host too, which is fine for now.

**No other changes to devcontainer.json.** Do not modify mounts, containerEnv, runArgs, or any other section.
  </action>
  <verify>
Verify postCreateCommand includes both scripts: `grep "install-agent-config" .devcontainer/devcontainer.json`. Verify the chaining is correct (&&, not ;): `grep "setup-container.sh && bash .devcontainer/install-agent-config.sh" .devcontainer/devcontainer.json`. Verify devcontainer.json is still valid JSON: `cat .devcontainer/devcontainer.json | python3 -c "import sys,json;json.load(sys.stdin);print('valid')"`. Verify the bind mount is still present (not removed): `grep "\.claude" .devcontainer/devcontainer.json`.
  </verify>
  <done>
devcontainer.json postCreateCommand chains install-agent-config.sh after setup-container.sh. The bind mount is preserved (Phase 3 scope). postStartCommand is unchanged. devcontainer.json is valid JSON.
  </done>
</task>

</tasks>

<verification>
- install-agent-config.sh is syntactically valid bash (shellcheck passes or manual review)
- install-agent-config.sh handles: config present, config missing, secrets present, secrets missing, both missing
- install-agent-config.sh generates settings.local.json from template with placeholder substitution
- install-agent-config.sh restores credentials from secrets.json when available
- install-agent-config.sh generates .mcp.json from enabled MCP templates
- install-agent-config.sh installs GSD framework idempotently
- install-agent-config.sh prints [install]-prefixed output for every action
- devcontainer.json postCreateCommand calls install-agent-config.sh after setup-container.sh
- All existing devcontainer functionality is preserved (bind mount, postStartCommand, containerEnv)
</verification>

<success_criteria>
The install script is the complete automation for Phase 1. When the container is created, it reads the two master files, hydrates templates, installs the GSD framework, and reports what was configured. The script handles all degraded modes gracefully per the locked "zero-config" decision. Running the script multiple times produces identical results without errors or duplicates.
</success_criteria>

<output>
After completion, create `.planning/phases/01-configuration-consolidation/01-02-SUMMARY.md`
</output>
