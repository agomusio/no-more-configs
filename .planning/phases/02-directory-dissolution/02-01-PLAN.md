---
phase: 02-directory-dissolution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - agent-config/skills/devcontainer/SKILL.md
  - agent-config/skills/gitprojects/SKILL.md
  - infra/docker-compose.yml
  - infra/docker-compose.test.yml
  - infra/.env
  - infra/.env.example
  - infra/README.md
  - infra/LICENSE
  - infra/hooks/
  - infra/mcp/
  - infra/scripts/generate-env.sh
  - infra/scripts/validate-setup.sh
  - infra/scripts/verify-filesystem-mcp.sh
  - infra/scripts/verify-gateway-connectivity.sh
  - infra/settings-examples/
  - infra/tests/
  - .devcontainer/Dockerfile
autonomous: true

must_haves:
  truths:
    - "Custom skills (devcontainer, gitprojects) exist in agent-config/skills/"
    - "Infrastructure stack exists in infra/ with all original langfuse-local/ contents"
    - "Verification scripts exist in infra/scripts/ alongside original langfuse-local/scripts/"
    - "Dockerfile defines LANGFUSE_STACK_DIR and CLAUDE_WORKSPACE environment variables"
    - "Dockerfile aliases launch claude without cd /workspace/claudehome prefix"
  artifacts:
    - path: "agent-config/skills/devcontainer/SKILL.md"
      provides: "Devcontainer custom skill"
      contains: "SKILL"
    - path: "agent-config/skills/gitprojects/SKILL.md"
      provides: "Gitprojects custom skill"
      contains: "SKILL"
    - path: "infra/docker-compose.yml"
      provides: "Langfuse + MCP gateway stack definition"
      contains: "langfuse"
    - path: "infra/scripts/verify-filesystem-mcp.sh"
      provides: "MCP filesystem verification"
    - path: "infra/scripts/verify-gateway-connectivity.sh"
      provides: "Gateway connectivity verification"
    - path: ".devcontainer/Dockerfile"
      provides: "Updated container image with env vars and new aliases"
      contains: "LANGFUSE_STACK_DIR"
  key_links:
    - from: ".devcontainer/Dockerfile"
      to: "shell env"
      via: "ENV directive + shell exports"
      pattern: "ENV LANGFUSE_STACK_DIR=/workspace/infra"
    - from: ".devcontainer/Dockerfile"
      to: "aliases"
      via: "bashrc/zshrc alias definitions"
      pattern: "alias claudey='claude --dangerously-skip-permissions'"
---

<objective>
Create the new directory structure by copying skills to agent-config/skills/, moving langfuse-local/ to infra/, moving verification scripts to infra/scripts/, and updating the Dockerfile with environment variables and directory-independent aliases.

Purpose: This is the ADD step of the add-wire-delete migration pattern. After this plan, both old and new file locations exist, so the container remains buildable. Environment variables and updated aliases prepare for Phase 2's reference rewiring.

Output: New directory structure (agent-config/skills/, infra/, infra/scripts/) plus updated Dockerfile with LANGFUSE_STACK_DIR, CLAUDE_WORKSPACE env vars and alias cleanup.
</objective>

<execution_context>
@/home/node/.claude/get-shit-done/workflows/execute-plan.md
@/home/node/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-directory-dissolution/02-RESEARCH.md
@.devcontainer/Dockerfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Redistribute claudehome/ contents to purpose-named locations</name>
  <files>
    agent-config/skills/devcontainer/SKILL.md
    agent-config/skills/gitprojects/SKILL.md
    infra/ (entire directory tree from claudehome/langfuse-local/)
    infra/scripts/verify-filesystem-mcp.sh
    infra/scripts/verify-gateway-connectivity.sh
  </files>
  <action>
    Copy custom skills from claudehome/ to agent-config/skills/:
    - Copy claudehome/.claude/skills/devcontainer/SKILL.md to agent-config/skills/devcontainer/SKILL.md
    - Copy claudehome/.claude/skills/gitprojects/SKILL.md to agent-config/skills/gitprojects/SKILL.md
    - Do NOT copy aa-cloudflare or aa-fullstack (these are vendor skills that reinstall independently, not custom skills)

    Move infrastructure stack from claudehome/langfuse-local/ to infra/:
    - Use git mv claudehome/langfuse-local infra (preserves git history)
    - This moves everything: docker-compose.yml, docker-compose.test.yml, .env, .env.example, README.md, LICENSE, hooks/, mcp/, scripts/, settings-examples/, tests/
    - After the mv, the langfuse-local scripts (generate-env.sh, validate-setup.sh) will be at infra/scripts/

    Move verification scripts from claudehome/scripts/ to infra/scripts/:
    - Use git mv claudehome/scripts/verify-filesystem-mcp.sh infra/scripts/verify-filesystem-mcp.sh
    - Use git mv claudehome/scripts/verify-gateway-connectivity.sh infra/scripts/verify-gateway-connectivity.sh
    - These verification scripts are separate from the langfuse scripts already in infra/scripts/
    - After this, claudehome/scripts/ should be empty and can be removed with git rm -r

    Do NOT move claudehome/.planning/ (it is OLD/stale from a different project scope -- will be deleted in Plan 02)
    Do NOT move claudehome/.claude/settings.local.json (replaced by install-agent-config.sh from Phase 1)
    Do NOT move claudehome/.claude/commands/ (GSD commands reinstall from npm)

    Commit message: "feat(02-01): redistribute claudehome contents to purpose-named locations"
  </action>
  <verify>
    Verify new files exist:
    - ls agent-config/skills/devcontainer/SKILL.md
    - ls agent-config/skills/gitprojects/SKILL.md
    - ls infra/docker-compose.yml
    - ls infra/scripts/generate-env.sh
    - ls infra/scripts/verify-filesystem-mcp.sh
    - ls infra/scripts/verify-gateway-connectivity.sh

    Verify git tracks the moves (git status shows renamed files, not deleted+added)
  </verify>
  <done>Custom skills exist in agent-config/skills/, infrastructure stack exists in infra/, and verification scripts exist in infra/scripts/. Git history is preserved via git mv.</done>
</task>

<task type="auto">
  <name>Task 2: Add environment variables and update aliases in Dockerfile</name>
  <files>.devcontainer/Dockerfile</files>
  <action>
    Add environment variables after the existing ENV block (after line ~100, near the other ENV declarations):
    ```dockerfile
    # Workspace path references (used by scripts, aliases, and runtime config)
    ENV LANGFUSE_STACK_DIR=/workspace/infra
    ENV CLAUDE_WORKSPACE=/workspace
    ```

    Also add shell exports for interactive sessions. Add a new RUN block after the ENV declarations:
    ```dockerfile
    # Export workspace paths for interactive shells
    RUN echo "export LANGFUSE_STACK_DIR=/workspace/infra" >> /home/node/.bashrc && \
        echo "export CLAUDE_WORKSPACE=/workspace" >> /home/node/.bashrc && \
        echo "export LANGFUSE_STACK_DIR=/workspace/infra" >> /home/node/.zshrc && \
        echo "export CLAUDE_WORKSPACE=/workspace" >> /home/node/.zshrc
    ```

    Update alias definitions (currently lines 134-137) to remove the "cd /workspace/claudehome &&" prefix:

    Before:
    ```dockerfile
    RUN echo "alias claudey='cd /workspace/claudehome && claude --dangerously-skip-permissions'" >> /home/node/.bashrc && \
        echo "alias claudeyr='cd /workspace/claudehome && claude --dangerously-skip-permissions --resume'" >> /home/node/.bashrc && \
        echo "alias claudey='cd /workspace/claudehome && claude --dangerously-skip-permissions'" >> /home/node/.zshrc && \
        echo "alias claudeyr='cd /workspace/claudehome && claude --dangerously-skip-permissions --resume'" >> /home/node/.zshrc
    ```

    After:
    ```dockerfile
    RUN echo "alias claudey='claude --dangerously-skip-permissions'" >> /home/node/.bashrc && \
        echo "alias claudeyr='claude --dangerously-skip-permissions --resume'" >> /home/node/.bashrc && \
        echo "alias claudey='claude --dangerously-skip-permissions'" >> /home/node/.zshrc && \
        echo "alias claudeyr='claude --dangerously-skip-permissions --resume'" >> /home/node/.zshrc
    ```

    IMPORTANT: Keep the comment above the alias block, just update the actual alias strings.

    Commit message: "refactor(02-01): add env vars and remove cd prefix from aliases"
  </action>
  <verify>
    Verify with grep:
    - grep "LANGFUSE_STACK_DIR" .devcontainer/Dockerfile (should find ENV and export lines)
    - grep "CLAUDE_WORKSPACE" .devcontainer/Dockerfile (should find ENV and export lines)
    - grep "claudey" .devcontainer/Dockerfile (should NOT contain "claudehome")
    - grep "claudehome" .devcontainer/Dockerfile (should return NO matches)
  </verify>
  <done>Dockerfile defines LANGFUSE_STACK_DIR=/workspace/infra and CLAUDE_WORKSPACE=/workspace as both ENV directives and shell exports. Aliases launch claude without cd prefix. No references to claudehome remain in Dockerfile.</done>
</task>

</tasks>

<verification>
Phase-level checks for Plan 01:
1. agent-config/skills/ contains devcontainer/ and gitprojects/ subdirectories with SKILL.md files
2. infra/ contains the complete langfuse-local stack (docker-compose.yml, .env, mcp/, hooks/, scripts/, etc.)
3. infra/scripts/ contains both langfuse scripts (generate-env.sh, validate-setup.sh) and verification scripts (verify-filesystem-mcp.sh, verify-gateway-connectivity.sh)
4. .devcontainer/Dockerfile has LANGFUSE_STACK_DIR and CLAUDE_WORKSPACE env vars
5. .devcontainer/Dockerfile aliases do not contain "claudehome"
6. claudehome/ still exists (not yet deleted -- that is Plan 02)
7. All changes committed with atomic commits preserving git history
</verification>

<success_criteria>
- New directory structure created with all files in correct locations
- Dockerfile updated with environment variables and clean aliases
- Git history preserved for moved files
- Container remains buildable (old paths still exist alongside new)
</success_criteria>

<output>
After completion, create `.planning/phases/02-directory-dissolution/02-01-SUMMARY.md`
</output>
