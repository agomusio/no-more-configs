---
phase: 03-runtime-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .devcontainer/devcontainer.json
  - .devcontainer/install-agent-config.sh
  - agent-config/hooks/langfuse_hook.py
autonomous: true

must_haves:
  truths:
    - "devcontainer.json mounts array has NO ~/.claude bind mount line"
    - "agent-config/hooks/langfuse_hook.py exists (copy of infra/hooks/langfuse_hook.py)"
    - "install-agent-config.sh copies agent-config/skills/* to ~/.claude/skills/"
    - "install-agent-config.sh copies agent-config/hooks/* to ~/.claude/hooks/"
    - "install-agent-config.sh copies agent-config/commands/* to ~/.claude/commands/ non-destructively"
    - "install-agent-config.sh detects unresolved {{PLACEHOLDER}} tokens in generated files, replaces with empty strings, and prints warnings"
  artifacts:
    - path: ".devcontainer/devcontainer.json"
      provides: "Container config without ~/.claude bind mount"
      contains: "mounts"
    - path: "agent-config/hooks/langfuse_hook.py"
      provides: "Langfuse tracing hook for agent config pipeline"
      contains: "langfuse"
    - path: ".devcontainer/install-agent-config.sh"
      provides: "Extended install script with asset copy and placeholder handling"
      contains: "skills"
  key_links:
    - from: ".devcontainer/install-agent-config.sh"
      to: "agent-config/skills/"
      via: "cp -r to ~/.claude/skills/"
      pattern: "cp -r"
    - from: ".devcontainer/install-agent-config.sh"
      to: "agent-config/hooks/"
      via: "cp to ~/.claude/hooks/"
      pattern: "hooks"
    - from: "agent-config/settings.json.template"
      to: "agent-config/hooks/langfuse_hook.py"
      via: "Hook command path /home/node/.claude/hooks/langfuse_hook.py"
      pattern: "langfuse_hook"
---

<objective>
Remove the ~/.claude host bind mount from devcontainer.json (isolated first commit), then extend install-agent-config.sh to copy skills, hooks, and commands from agent-config/ to ~/.claude/, and add unresolved placeholder detection.

Purpose: After this plan, the container is fully independent from the host's ~/.claude directory. All agent configuration is generated/copied at build time from version-controlled source files. This is the foundational change that makes the entire refactor meaningful.

Output: devcontainer.json without bind mount, agent-config/hooks/ with langfuse hook, install script with asset copy pipeline and placeholder warning system.
</objective>

<execution_context>
@/home/node/.claude/get-shit-done/workflows/execute-plan.md
@/home/node/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-runtime-generation/03-RESEARCH.md
@.devcontainer/devcontainer.json
@.devcontainer/install-agent-config.sh
@agent-config/settings.json.template
@infra/hooks/langfuse_hook.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove ~/.claude bind mount from devcontainer.json (CTR-01)</name>
  <files>.devcontainer/devcontainer.json</files>
  <action>
    Remove the ~/.claude bind mount line from the "mounts" array in devcontainer.json.

    The mounts array currently has 3 entries:
    ```json
    "mounts": [
      "source=claude-code-bashhistory-${devcontainerId},target=/commandhistory,type=volume",
      "source=${localEnv:USERPROFILE}/.claude,target=/home/node/.claude,type=bind",
      "source=/var/run/docker.sock,target=/var/run/docker.sock,type=bind"
    ],
    ```

    Remove ONLY the middle line (the ~/.claude bind mount). Result should be:
    ```json
    "mounts": [
      "source=claude-code-bashhistory-${devcontainerId},target=/commandhistory,type=volume",
      "source=/var/run/docker.sock,target=/var/run/docker.sock,type=bind"
    ],
    ```

    Also remove the CLAUDE_CONFIG_DIR containerEnv entry since it referenced the bind mount target:
    Remove this line from containerEnv: `"CLAUDE_CONFIG_DIR": "/home/node/.claude",`
    (The default CLAUDE_CONFIG_DIR is already ~/.claude which resolves to /home/node/.claude for the node user.)

    IMPORTANT: This is the riskiest single change in the entire refactor. It MUST be its own isolated commit for easy revert.

    Commit message: "feat(03-01): remove ~/.claude host bind mount (CTR-01)"
  </action>
  <verify>
    Verify bind mount is removed:
    - grep "USERPROFILE" .devcontainer/devcontainer.json (should return NO matches)
    - grep "\.claude" .devcontainer/devcontainer.json (should match only in containerEnv/settings if any, NOT in mounts)

    Verify remaining mounts are intact:
    - grep "bashhistory" .devcontainer/devcontainer.json (should match — bash history volume)
    - grep "docker.sock" .devcontainer/devcontainer.json (should match — Docker socket)

    Verify JSON is valid:
    - python3 -c "import json; json.load(open('.devcontainer/devcontainer.json'))" (should succeed)
  </verify>
  <done>devcontainer.json no longer bind-mounts ~/.claude from the Windows host. The container will start with an empty /home/node/.claude/ directory, and install-agent-config.sh (postCreateCommand) will populate it. This commit is isolated for easy revert if auth breaks.</done>
</task>

<task type="auto">
  <name>Task 2: Create agent-config/hooks/ with langfuse hook</name>
  <files>agent-config/hooks/langfuse_hook.py</files>
  <action>
    Copy the langfuse hook from infra/hooks/ to agent-config/hooks/:

    ```bash
    mkdir -p agent-config/hooks
    cp infra/hooks/langfuse_hook.py agent-config/hooks/langfuse_hook.py
    ```

    The infra/hooks/ copy stays as-is — it serves the standalone Langfuse setup (infra/scripts/install-hook.sh).
    The agent-config/hooks/ copy is what the install-agent-config.sh pipeline will copy to ~/.claude/hooks/.

    The settings.json.template already references this hook at:
    `"command": "python3 /home/node/.claude/hooks/langfuse_hook.py"`

    After install-agent-config.sh copies agent-config/hooks/* to ~/.claude/hooks/, this path will resolve correctly.

    Commit message: "feat(03-01): add langfuse hook to agent-config pipeline (AGT-04)"
  </action>
  <verify>
    - ls agent-config/hooks/langfuse_hook.py (should exist)
    - diff agent-config/hooks/langfuse_hook.py infra/hooks/langfuse_hook.py (should be identical)
  </verify>
  <done>langfuse_hook.py exists in agent-config/hooks/ for the asset copy pipeline. The infra/hooks/ copy is preserved for standalone Langfuse installation.</done>
</task>

<task type="auto">
  <name>Task 3: Extend install-agent-config.sh with asset copy + placeholder handling</name>
  <files>.devcontainer/install-agent-config.sh</files>
  <action>
    Add three new sections to install-agent-config.sh, AFTER the existing "Create directories" block (after line 84) and BEFORE the "Generate settings.local.json" block:

    **Section A: Copy skills (AGT-03)**
    ```bash
    # Copy skills from agent-config to runtime location (AGT-03)
    SKILLS_COUNT=0
    if [ -d "$AGENT_CONFIG_DIR/skills" ]; then
        cp -r "$AGENT_CONFIG_DIR/skills/"* "$CLAUDE_DIR/skills/" 2>/dev/null || true
        SKILLS_COUNT=$(find "$AGENT_CONFIG_DIR/skills" -maxdepth 1 -mindepth 1 -type d 2>/dev/null | wc -l)
        echo "[install] Copied $SKILLS_COUNT skill(s) to $CLAUDE_DIR/skills/"
    fi
    ```

    **Section B: Copy hooks (AGT-04)**
    ```bash
    # Copy hooks from agent-config to runtime location (AGT-04)
    HOOKS_COUNT=0
    if [ -d "$AGENT_CONFIG_DIR/hooks" ]; then
        cp "$AGENT_CONFIG_DIR/hooks/"* "$CLAUDE_DIR/hooks/" 2>/dev/null || true
        HOOKS_COUNT=$(find "$AGENT_CONFIG_DIR/hooks" -maxdepth 1 -type f 2>/dev/null | wc -l)
        echo "[install] Copied $HOOKS_COUNT hook(s) to $CLAUDE_DIR/hooks/"
    fi
    ```

    **Section C: Copy commands non-destructively (AGT-05)**
    ```bash
    # Copy commands from agent-config, non-destructive — don't overwrite GSD (AGT-05)
    COMMANDS_COUNT=0
    if [ -d "$AGENT_CONFIG_DIR/commands" ]; then
        cp -rn "$AGENT_CONFIG_DIR/commands/"* "$CLAUDE_DIR/commands/" 2>/dev/null || true
        COMMANDS_COUNT=$(find "$AGENT_CONFIG_DIR/commands" -maxdepth 1 -mindepth 1 2>/dev/null | wc -l)
        echo "[install] Copied $COMMANDS_COUNT command source(s) to $CLAUDE_DIR/commands/ (non-destructive)"
    fi
    ```

    Then add a placeholder handling section AFTER all template hydration (after the MCP generation block, before the GSD install block):

    **Section D: Unresolved placeholder detection (GEN-06)**
    ```bash
    # Detect unresolved {{PLACEHOLDER}} tokens in generated files (GEN-06)
    UNRESOLVED=""
    for generated_file in "$CLAUDE_DIR/settings.local.json" "$WORKSPACE_ROOT/.mcp.json"; do
        if [ -f "$generated_file" ]; then
            tokens=$(grep -oP '\{\{[A-Z_]+\}\}' "$generated_file" 2>/dev/null || true)
            if [ -n "$tokens" ]; then
                UNRESOLVED="$UNRESOLVED $tokens"
                # Replace unresolved tokens with empty strings
                sed -i 's/{{[A-Z_]*}}//g' "$generated_file"
            fi
        fi
    done
    if [ -n "$UNRESOLVED" ]; then
        echo "[install] WARNING: Unresolved placeholders replaced with empty strings:$UNRESOLVED"
    fi
    ```

    Update the summary section to include asset counts:
    ```bash
    echo "[install] Skills: $SKILLS_COUNT skill(s)"
    echo "[install] Hooks: $HOOKS_COUNT hook(s)"
    echo "[install] Commands: $COMMANDS_COUNT command source(s)"
    ```

    Commit message: "feat(03-01): add asset copy pipeline and placeholder handling (AGT-03/04/05, GEN-06)"
  </action>
  <verify>
    Verify new sections exist in the script:
    - grep "skills" .devcontainer/install-agent-config.sh (should find copy logic)
    - grep "hooks" .devcontainer/install-agent-config.sh (should find copy logic)
    - grep "commands" .devcontainer/install-agent-config.sh (should find copy logic, non-destructive)
    - grep "UNRESOLVED" .devcontainer/install-agent-config.sh (should find placeholder detection)
    - grep "cp -rn" .devcontainer/install-agent-config.sh (should find non-destructive command copy)

    Verify script syntax:
    - bash -n .devcontainer/install-agent-config.sh (should succeed — syntax check only)
  </verify>
  <done>install-agent-config.sh copies skills (4 skill directories), hooks (langfuse_hook.py), and commands (non-destructive, won't overwrite GSD) from agent-config/ to ~/.claude/. Unresolved {{PLACEHOLDER}} tokens are detected, replaced with empty strings, and warned about. Summary output includes asset counts.</done>
</task>

</tasks>

<verification>
Phase-level checks for Plan 01:

Requirements verification:
- CTR-01: Bind mount removed — `grep "USERPROFILE" .devcontainer/devcontainer.json` returns nothing
- AGT-03: Skills copy logic — `grep "skills" .devcontainer/install-agent-config.sh` finds cp command
- AGT-04: Hooks copy logic — `grep "hooks" .devcontainer/install-agent-config.sh` finds cp command + `ls agent-config/hooks/langfuse_hook.py` succeeds
- AGT-05: Commands copy (non-destructive) — `grep "cp -rn" .devcontainer/install-agent-config.sh` finds command copy
- GEN-06: Placeholder handling — `grep "UNRESOLVED" .devcontainer/install-agent-config.sh` finds detection logic

Integration checks:
- settings.json.template hook path (`/home/node/.claude/hooks/langfuse_hook.py`) will resolve after install script copies `agent-config/hooks/langfuse_hook.py` to `~/.claude/hooks/`
- GSD commands protected from overwrite by `-rn` flag on command copy
- JSON validity of devcontainer.json: `python3 -c "import json; json.load(open('.devcontainer/devcontainer.json'))"`
- Script syntax: `bash -n .devcontainer/install-agent-config.sh`
</verification>

<success_criteria>
- devcontainer.json no longer bind-mounts ~/.claude from host (CTR-01 — isolated first commit)
- agent-config/hooks/langfuse_hook.py exists for the asset pipeline
- install-agent-config.sh copies skills, hooks, and commands from agent-config/ to ~/.claude/
- Commands copy is non-destructive (won't overwrite GSD)
- Unresolved placeholders detected, replaced with empty strings, and warned about
- All changes committed atomically (3 commits: bind mount removal, hook file, script extension)
</success_criteria>

<output>
After completion, create `.planning/phases/03-runtime-generation/03-01-SUMMARY.md`
</output>
