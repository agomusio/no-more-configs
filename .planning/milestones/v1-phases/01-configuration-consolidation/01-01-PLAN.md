---
phase: 01-configuration-consolidation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - config.json
  - config.example.json
  - secrets.example.json
  - .gitignore
  - agent-config/settings.json.template
  - agent-config/mcp-templates/mcp-gateway.json
must_haves:
  truths:
    - "config.json exists at repo root with nested object schema matching locked decision (firewall, langfuse, agent, vscode, mcp_servers top-level keys)"
    - "secrets.example.json exists at repo root with placeholder schema matching locked decision (claude, langfuse, api_keys top-level keys)"
    - "config.example.json exists showing the same schema as config.json with sensible defaults"
    - "agent-config/ directory exists as version-controlled source of truth with settings template and MCP templates"
    - "settings.json.template contains {{PLACEHOLDER}} tokens for values that come from config.json and secrets.json"
    - "secrets.json is gitignored; config.json is committed"
  artifacts:
    - path: "config.json"
      provides: "Master non-secret settings file"
      contains: "firewall"
    - path: "config.example.json"
      provides: "Example config with sensible defaults"
      contains: "firewall"
    - path: "secrets.example.json"
      provides: "Example secrets with placeholder schema"
      contains: "claude"
    - path: "agent-config/settings.json.template"
      provides: "Template for ~/.claude/settings.local.json with placeholder tokens"
      contains: "{{LANGFUSE_HOST}}"
    - path: "agent-config/mcp-templates/mcp-gateway.json"
      provides: "MCP gateway server template"
      contains: "mcp-gateway"
  key_links:
    - from: "config.json"
      to: "agent-config/settings.json.template"
      via: "shared key names — config.json values fill template placeholders"
      pattern: "langfuse\\.host.*LANGFUSE_HOST"
    - from: "secrets.example.json"
      to: "agent-config/settings.json.template"
      via: "secret values fill credential placeholders"
      pattern: "LANGFUSE_SECRET_KEY"
autonomous: true
---

<objective>
Create the two master configuration files (config.json + secrets.json schema), their example templates, and the agent-config/ directory with settings and MCP templates.

Purpose: Establish the configuration foundation that Phase 1's install script will read from. These files define the contract — what settings exist, what secrets are needed, and what templates get hydrated.

Output: config.json (committed), secrets.example.json (committed), config.example.json (committed), agent-config/ directory with settings template and MCP templates, updated .gitignore for secrets.json.
</objective>

<execution_context>
@C:/Users/sam/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-configuration-consolidation/01-RESEARCH.md
@.planning/phase-1-CONTEXT.md
@.devcontainer/devcontainer.json
@.devcontainer/mcp-setup-bin.sh
@claudehome/.claude/settings.local.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create config.json, config.example.json, and secrets.example.json</name>
  <files>
    config.json
    config.example.json
    secrets.example.json
    .gitignore
  </files>
  <action>
Create three JSON files at the repo root and update .gitignore.

**config.json** — The real config file (committed to git). Use the EXACT schema from the locked decision. Populate with current actual values from the existing codebase:

```json
{
  "firewall": {
    "extra_domains": ["adventure-alerts-api.sam-ed4.workers.dev"]
  },
  "langfuse": {
    "host": "http://host.docker.internal:3052"
  },
  "agent": {
    "defaults": {}
  },
  "vscode": {
    "git_scan_paths": []
  },
  "mcp_servers": {
    "mcp-gateway": {
      "enabled": true
    }
  }
}
```

Notes on values:
- `firewall.extra_domains`: Pull from current `.devcontainer/firewall-domains.conf` (currently just `adventure-alerts-api.sam-ed4.workers.dev`)
- `langfuse.host`: Pull from current `devcontainer.json` containerEnv (currently `http://host.docker.internal:3052`)
- `vscode.git_scan_paths`: Empty array means auto-detect from gitprojects/ (per locked decision — absence = auto-detect)
- `mcp_servers`: Reference the mcp-gateway template with enabled flag. The actual server config (command, args, url) lives in `agent-config/mcp-templates/mcp-gateway.json`

**config.example.json** — Identical to config.json but with generic placeholder values:

```json
{
  "firewall": {
    "extra_domains": ["your-api.example.com"]
  },
  "langfuse": {
    "host": "http://host.docker.internal:3052"
  },
  "agent": {
    "defaults": {}
  },
  "vscode": {
    "git_scan_paths": []
  },
  "mcp_servers": {
    "mcp-gateway": {
      "enabled": true
    }
  }
}
```

**secrets.example.json** — Committed placeholder showing the required schema. Use the EXACT schema from the locked decision. All credential values are empty strings:

```json
{
  "claude": {
    "credentials": {}
  },
  "langfuse": {
    "public_key": "",
    "secret_key": ""
  },
  "api_keys": {
    "openai": "",
    "google": ""
  }
}
```

Note: The CONTEXT.md says `"claude": { "auth": {} }` but the RESEARCH.md clarifies the actual structure is `.credentials.json` content under `claude.credentials`. Use `"credentials": {}` as the key name since that matches what the install script will restore to `~/.claude/.credentials.json`.

**Update .gitignore** — Add `secrets.json` to gitignore (MUST NOT be committed). Add it in a new section after the existing "Environment secrets" section:

```
# Sandbox secrets (credentials, API keys)
secrets.json
```

Do NOT gitignore config.json — it is committed.
  </action>
  <verify>
Verify all three JSON files are valid: `cat config.json | python3 -c "import sys,json;json.load(sys.stdin);print('valid')"` (repeat for config.example.json and secrets.example.json). Verify secrets.json appears in .gitignore: `grep "secrets.json" .gitignore`. Verify config.json is NOT in .gitignore: confirm `grep "config.json" .gitignore` returns nothing (the grep for config.example.json or config.json should not match a gitignore rule for config.json itself).
  </verify>
  <done>
config.json exists with nested schema (firewall, langfuse, agent, vscode, mcp_servers keys) populated with current codebase values. config.example.json exists with same schema and generic placeholders. secrets.example.json exists with credential schema (claude.credentials, langfuse, api_keys). secrets.json is in .gitignore. All files are valid JSON.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create agent-config/ directory with settings template and MCP templates</name>
  <files>
    agent-config/settings.json.template
    agent-config/mcp-templates/mcp-gateway.json
  </files>
  <action>
Create the `agent-config/` directory structure as the version-controlled source of truth for agent configuration templates.

**agent-config/settings.json.template** — Template for generating `~/.claude/settings.local.json` at install time. Uses `{{PLACEHOLDER}}` tokens that the install script will replace with values from config.json and secrets.json.

Base the template on the current `claudehome/.claude/settings.local.json` but replace hardcoded values with placeholders:

```json
{
  "permissions": {
    "additionalDirectories": [
      "/workspace/",
      "/workspace/gitprojects/"
    ],
    "defaultMode": "bypassPermissions"
  },
  "env": {
    "TRACE_TO_LANGFUSE": "true",
    "LANGFUSE_HOST": "{{LANGFUSE_HOST}}",
    "LANGFUSE_PUBLIC_KEY": "{{LANGFUSE_PUBLIC_KEY}}",
    "LANGFUSE_SECRET_KEY": "{{LANGFUSE_SECRET_KEY}}"
  },
  "hooks": {
    "Stop": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "python3 /home/node/.claude/hooks/langfuse_hook.py"
          }
        ]
      }
    ]
  }
}
```

Placeholder mapping (document in a comment block at the top of the file, or in a separate README — since JSON doesn't support comments, add a `_template_info` key):

Actually, do NOT add a metadata key — keep it as pure JSON that becomes valid settings after hydration. Instead, the placeholder names are self-documenting:
- `{{LANGFUSE_HOST}}` ← from config.json `.langfuse.host`
- `{{LANGFUSE_PUBLIC_KEY}}` ← from secrets.json `.langfuse.public_key`
- `{{LANGFUSE_SECRET_KEY}}` ← from secrets.json `.langfuse.secret_key`

Note: The `additionalDirectories` array is hardcoded (not templated) because it always includes `/workspace/` and `/workspace/gitprojects/`. Phase 3 could add dynamic project paths later.

**agent-config/mcp-templates/mcp-gateway.json** — Template for the MCP gateway server config. Based on current `mcp-setup-bin.sh` output:

```json
{
  "mcp-gateway": {
    "type": "sse",
    "url": "{{MCP_GATEWAY_URL}}/sse"
  }
}
```

Placeholder:
- `{{MCP_GATEWAY_URL}}` ← from devcontainer.json containerEnv or defaults to `http://host.docker.internal:8811`

This template is referenced by `config.json` under `mcp_servers.mcp-gateway`. The install script reads config.json to know which templates to hydrate, then substitutes placeholders.
  </action>
  <verify>
Verify directory structure exists: `ls -R agent-config/`. Verify settings template contains placeholders: `grep "{{LANGFUSE_HOST}}" agent-config/settings.json.template`. Verify MCP template contains placeholder: `grep "{{MCP_GATEWAY_URL}}" agent-config/mcp-templates/mcp-gateway.json`. Verify both files are valid JSON (except for the placeholder tokens — the `{{...}}` tokens make it technically invalid JSON, but the structure is correct). Verify with: `cat agent-config/settings.json.template | sed 's/{{[^}]*}}/\"placeholder\"/g' | python3 -c "import sys,json;json.load(sys.stdin);print('valid')"` — sed replaces placeholders with quoted strings, then validates JSON structure.
  </verify>
  <done>
agent-config/ directory exists with settings.json.template (containing {{LANGFUSE_HOST}}, {{LANGFUSE_PUBLIC_KEY}}, {{LANGFUSE_SECRET_KEY}} placeholders based on current settings.local.json structure) and mcp-templates/mcp-gateway.json (containing {{MCP_GATEWAY_URL}} placeholder based on current mcp-setup output).
  </done>
</task>

</tasks>

<verification>
- config.json at repo root is valid JSON with all 5 top-level keys (firewall, langfuse, agent, vscode, mcp_servers)
- config.example.json at repo root is valid JSON with same structure and generic values
- secrets.example.json at repo root is valid JSON with credential schema (claude, langfuse, api_keys)
- secrets.json appears in .gitignore
- agent-config/settings.json.template exists with {{PLACEHOLDER}} tokens
- agent-config/mcp-templates/mcp-gateway.json exists with {{MCP_GATEWAY_URL}}
- No secrets or real credentials appear in any committed file
</verification>

<success_criteria>
All configuration source files exist and define the contract for Phase 1's install script. config.json contains current actual values, example files show schema with placeholders, templates contain hydration tokens. The agent-config/ directory is the version-controlled source of truth per the locked decision.
</success_criteria>

<output>
After completion, create `.planning/phases/01-configuration-consolidation/01-01-SUMMARY.md`
</output>
