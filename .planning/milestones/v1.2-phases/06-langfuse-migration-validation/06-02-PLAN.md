---
phase: 06-langfuse-migration-validation
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - .devcontainer/install-agent-config.sh
autonomous: true

must_haves:
  truths:
    - "Install script warns when a plugin hook references a non-existent script file and skips the entire plugin"
    - "Install script warns when a plugin file would overwrite an existing file from another plugin"
    - "Invalid plugin.json produces a friendly error with plugin name, followed by the raw JSON parse error"
    - "Install summary includes per-plugin breakdown and total warning count"
    - "Warnings appear inline during processing AND are recapped in a dedicated section after the summary"
    - "Plugin env vars declared but empty after hydration produce a warning"
  artifacts:
    - path: ".devcontainer/install-agent-config.sh"
      provides: "Enhanced validation, warnings, and summary"
      contains: "PLUGIN_WARNING_MESSAGES"
  key_links:
    - from: ".devcontainer/install-agent-config.sh"
      to: "stdout"
      via: "echo statements"
      pattern: "PLUGIN_WARNING_MESSAGES\\|Warnings Recap"
---

<objective>
Add validation warnings and enhanced install summaries to the plugin system. Warnings appear inline as encountered and are recapped at the end. Invalid manifests, missing hook scripts, and file overwrites produce clear, actionable messages.

Purpose: Make plugin issues easy to debug without reading through full install logs. Users see what went wrong and for which plugin.

Output: Enhanced install-agent-config.sh with hook script validation, file overwrite detection, improved JSON error messages, per-plugin summary, and warnings recap.
</objective>

<execution_context>
@/home/node/.claude/get-shit-done/workflows/execute-plan.md
@/home/node/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-langfuse-migration-validation/06-RESEARCH.md
@.planning/phases/06-langfuse-migration-validation/06-01-SUMMARY.md
@.devcontainer/install-agent-config.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add hook script validation, file overwrite detection, and improved JSON errors</name>
  <files>.devcontainer/install-agent-config.sh</files>
  <action>
    **Part A: Initialize warning message accumulator**

    Near the existing counter initialization (line 44: `PLUGIN_WARNINGS=0`), add:
    ```bash
    declare -a PLUGIN_WARNING_MESSAGES=()
    ```
    This array stores full warning messages for the recap section at the end.

    **Part B: Improve validate_json to show parse errors (VAL-04)**

    Update the `validate_json()` function (lines 18-27) to show a friendly error first, then the raw parse error on the next line (per user decision):

    ```bash
    validate_json() {
        local file="$1"
        local label="$2"
        if ! jq empty < "$file" &>/dev/null; then
            local parse_error
            parse_error=$(jq empty < "$file" 2>&1 || true)
            echo "[install] ERROR: $label has invalid JSON format"
            echo "[install]   $parse_error"
            PLUGIN_WARNING_MESSAGES+=("$label: invalid JSON — $parse_error")
            PLUGIN_WARNINGS=$((PLUGIN_WARNINGS + 1))
            return 1
        fi
        return 0
    }
    ```

    NOTE: This function is also used for config.json and secrets.json validation (lines 48, 64). The PLUGIN_WARNING_MESSAGES array and PLUGIN_WARNINGS counter must be initialized BEFORE these calls. Move the `declare -a PLUGIN_WARNING_MESSAGES=()` and `PLUGIN_WARNINGS=0` initialization to right after the other counter initializations (before line 46 where config.json loading begins). Actually they're already at line 44 — just add the array declaration there.

    Wait — the validate_json function is called for config.json (line 48) and secrets.json (line 64) which are NOT plugins. Adding to PLUGIN_WARNING_MESSAGES for those would be misleading. Either:
    (a) Only update PLUGIN_WARNING_MESSAGES inside the plugin loop's validate_json call, OR
    (b) Make the function check if we're in plugin context

    Simplest approach: Don't modify the global validate_json function. Instead, add the enhanced error handling ONLY in the plugin loop where validate_json is called (line 333). Override behavior there:

    Replace the plugin.json validation block (lines 332-336):
    ```bash
    # Validate plugin.json is valid JSON (VAL-04: friendly error + parse details)
    if ! jq empty < "$MANIFEST" &>/dev/null; then
        local parse_error
        parse_error=$(jq empty < "$MANIFEST" 2>&1 || true)
        echo "[install] ERROR: Plugin '$plugin_name' has invalid plugin.json"
        echo "[install]   $parse_error"
        PLUGIN_WARNINGS=$((PLUGIN_WARNINGS + 1))
        PLUGIN_WARNING_MESSAGES+=("Plugin '$plugin_name': invalid plugin.json — $parse_error")
        PLUGIN_SKIPPED=$((PLUGIN_SKIPPED + 1))
        continue
    fi
    ```

    **Part C: Add hook script validation (VAL-01)**

    After the plugin is validated (after line 346, before file copying begins at line 349), add hook script validation. Per user decision: missing hook script file → warn and skip the ENTIRE plugin.

    ```bash
    # Validate hook scripts exist in plugin directory (VAL-01)
    MANIFEST_HOOK_CHECK=$(jq -r '.hooks // {}' "$MANIFEST" 2>/dev/null || echo "{}")
    if [ "$MANIFEST_HOOK_CHECK" != "{}" ] && [ "$MANIFEST_HOOK_CHECK" != "null" ]; then
        hook_valid=true
        hook_commands=$(echo "$MANIFEST_HOOK_CHECK" | jq -r '.[][] | select(.type == "command") | .command' 2>/dev/null || true)
        for hook_cmd in $hook_commands; do
            # Extract script path from command (handles: python3 /path/to/script.py)
            hook_script=$(echo "$hook_cmd" | awk '{for(i=1;i<=NF;i++) if($i ~ /\.py$|\.sh$/) print $i}')
            if [ -n "$hook_script" ]; then
                hook_basename=$(basename "$hook_script")
                if [ ! -f "$plugin_dir/hooks/$hook_basename" ]; then
                    echo "[install] WARNING: Plugin '$plugin_name' hook references non-existent script: $hook_basename"
                    PLUGIN_WARNINGS=$((PLUGIN_WARNINGS + 1))
                    PLUGIN_WARNING_MESSAGES+=("Plugin '$plugin_name': hook script missing — $hook_basename")
                    hook_valid=false
                fi
            fi
        done
        if [ "$hook_valid" = false ]; then
            echo "[install] Plugin '$plugin_name': skipped (missing hook script)"
            PLUGIN_SKIPPED=$((PLUGIN_SKIPPED + 1))
            continue
        fi
    fi
    ```

    **Part D: Add file overwrite detection between plugins (VAL-02)**

    Before the plugin loop (around line 298), add an associative array to track file ownership:
    ```bash
    declare -A PLUGIN_FILE_OWNERS=()
    ```

    In the hook copy section (lines 357-363), before `cp`, check if another plugin already owns this file. Use "first wins" strategy (consistent with env var conflict resolution per research recommendation):

    ```bash
    # Copy hooks (with overwrite detection)
    if [ -d "$plugin_dir/hooks" ]; then
        for hook_file in "$plugin_dir/hooks"/*; do
            [ -f "$hook_file" ] || continue
            hook_basename=$(basename "$hook_file")
            if [ -n "${PLUGIN_FILE_OWNERS[hooks/$hook_basename]+x}" ]; then
                echo "[install] WARNING: Plugin '$plugin_name' hook file '$hook_basename' conflicts with plugin '${PLUGIN_FILE_OWNERS[hooks/$hook_basename]}' — skipping file"
                PLUGIN_WARNINGS=$((PLUGIN_WARNINGS + 1))
                PLUGIN_WARNING_MESSAGES+=("Plugin '$plugin_name': hook file '$hook_basename' conflicts with '${PLUGIN_FILE_OWNERS[hooks/$hook_basename]}'")
            else
                PLUGIN_FILE_OWNERS["hooks/$hook_basename"]="$plugin_name"
                cp "$hook_file" "$CLAUDE_DIR/hooks/"
            fi
        done
        plugin_hooks_count=$(find "$plugin_dir/hooks" -maxdepth 1 -type f 2>/dev/null | wc -l)
    fi
    ```

    Apply the same pattern to commands copy (lines 366-377) and agents copy (lines 380-392). For skills, they are directory-based, so check directory names:

    Commands:
    ```bash
    for cmd_file in "$plugin_dir/commands"/*.md; do
        [ -f "$cmd_file" ] || continue
        cmd_basename=$(basename "$cmd_file")
        if [ -n "${PLUGIN_FILE_OWNERS[commands/$cmd_basename]+x}" ]; then
            echo "[install] WARNING: Plugin '$plugin_name' command '$cmd_basename' conflicts with plugin '${PLUGIN_FILE_OWNERS[commands/$cmd_basename]}' — skipping file"
            PLUGIN_WARNINGS=$((PLUGIN_WARNINGS + 1))
            PLUGIN_WARNING_MESSAGES+=("Plugin '$plugin_name': command '$cmd_basename' conflicts with '${PLUGIN_FILE_OWNERS[commands/$cmd_basename]}'")
        else
            PLUGIN_FILE_OWNERS["commands/$cmd_basename"]="$plugin_name"
            cp "$cmd_file" "$CLAUDE_DIR/commands/"
        fi
    done
    ```

    Agents (keep existing GSD protection, add overwrite detection):
    ```bash
    for agent_file in "$plugin_dir/agents"/*.md; do
        [ -f "$agent_file" ] || continue
        agent_name=$(basename "$agent_file")
        if [[ "$agent_name" =~ ^gsd- ]]; then
            echo "[install] ERROR: Plugin '$plugin_name' attempted to overwrite GSD-protected file agents/$agent_name -- skipping"
            PLUGIN_WARNINGS=$((PLUGIN_WARNINGS + 1))
            PLUGIN_WARNING_MESSAGES+=("Plugin '$plugin_name': GSD-protected agents/$agent_name")
            continue
        fi
        if [ -n "${PLUGIN_FILE_OWNERS[agents/$agent_name]+x}" ]; then
            echo "[install] WARNING: Plugin '$plugin_name' agent '$agent_name' conflicts with plugin '${PLUGIN_FILE_OWNERS[agents/$agent_name]}' — skipping file"
            PLUGIN_WARNINGS=$((PLUGIN_WARNINGS + 1))
            PLUGIN_WARNING_MESSAGES+=("Plugin '$plugin_name': agent '$agent_name' conflicts with '${PLUGIN_FILE_OWNERS[agents/$agent_name]}'")
        else
            PLUGIN_FILE_OWNERS["agents/$agent_name"]="$plugin_name"
            cp "$agent_file" "$CLAUDE_DIR/agents/"
        fi
    done
    ```

    **Part E: Store existing warnings in PLUGIN_WARNING_MESSAGES**

    Update existing warning locations to also append to PLUGIN_WARNING_MESSAGES:

    1. Plugin name mismatch (line 341-344): add `PLUGIN_WARNING_MESSAGES+=("Plugin '$plugin_name': manifest name '$manifest_name' does not match directory name")`

    2. Env var conflict (line 412-413): add `PLUGIN_WARNING_MESSAGES+=("Plugin '$plugin_name': env var conflict: $CONFLICTS (first plugin wins)")`

    3. GSD directory conflict (line 369-371): add `PLUGIN_WARNING_MESSAGES+=("Plugin '$plugin_name': GSD-protected commands/gsd/ directory")`

    **Part F: Warn on empty env vars after hydration**

    After plugin env hydration (added in Plan 01) and before PLUGIN_ENV merging, check for env vars that have `{{TOKEN}}` still unresolved (meaning hydration couldn't find the secret):

    In the plugin loop, after the env hydration block (added by Plan 01), add:
    ```bash
    # Check for unresolved {{TOKEN}} patterns in plugin env (empty after hydration)
    unresolved_env=$(echo "$MANIFEST_ENV" | jq -r 'to_entries[] | select(.value | test("^\\{\\{.*\\}\\}$")) | .key' 2>/dev/null || true)
    if [ -n "$unresolved_env" ]; then
        for unresolved_var in $unresolved_env; do
            echo "[install] WARNING: Plugin '$plugin_name' env var '$unresolved_var' has unresolved placeholder"
            PLUGIN_WARNINGS=$((PLUGIN_WARNINGS + 1))
            PLUGIN_WARNING_MESSAGES+=("Plugin '$plugin_name': env var '$unresolved_var' has unresolved {{TOKEN}} placeholder")
        done
    fi
    ```

    This does NOT skip the plugin — per user decision, empty env vars are warnings, not fatal.
  </action>
  <verify>
    - `bash -n .devcontainer/install-agent-config.sh` passes (valid syntax)
    - `grep 'PLUGIN_WARNING_MESSAGES' .devcontainer/install-agent-config.sh` shows the array is declared and populated
    - `grep 'hook_valid' .devcontainer/install-agent-config.sh` confirms hook script validation exists
    - `grep 'PLUGIN_FILE_OWNERS' .devcontainer/install-agent-config.sh` confirms file overwrite tracking exists
    - `grep 'invalid JSON format\|parse_error\|Parse error' .devcontainer/install-agent-config.sh` confirms improved JSON error messages
    - `grep 'unresolved placeholder\|unresolved_env' .devcontainer/install-agent-config.sh` confirms env var warning
  </verify>
  <done>
    Install script validates hook scripts exist (skips plugin if missing), detects file overwrites between plugins (first wins), shows friendly JSON parse errors with raw details, warns on unresolved env var placeholders, and all warnings are stored in PLUGIN_WARNING_MESSAGES array for recap.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance install summary with per-plugin details and warnings recap</name>
  <files>.devcontainer/install-agent-config.sh</files>
  <action>
    **Part A: Update the existing plugin recap section**

    The current plugin recap section (lines 479-508) already shows totals. Enhance it to also show the per-plugin breakdown. The per-plugin detail logging already exists at lines 448-469 (prints during the loop), so the inline output is covered.

    Update the recap section to include the compact per-plugin format requested by the user (`langfuse-tracing: 1 hook, 2 env, 1 MCP`). This is ALREADY done by the per-plugin detail logging at lines 448-469. The user wanted this integrated into the final summary, not just during the loop.

    Store per-plugin detail strings during the loop for replay in summary. Before the plugin loop, add:
    ```bash
    declare -a PLUGIN_DETAIL_LINES=()
    ```

    At the end of the per-plugin detail logging (around line 465-468), also store the detail:
    ```bash
    if [ -n "$detail_str" ]; then
        PLUGIN_DETAIL_LINES+=("  $plugin_name: $detail_str")
    else
        PLUGIN_DETAIL_LINES+=("  $plugin_name: manifest only")
    fi
    ```

    **Part B: Integrate plugin details into main summary**

    Update the final summary section (lines 760-775). The current `Plugins:` line shows `N installed, M skipped`. Enhance it:

    Replace the Plugins line and add per-plugin breakdown:
    ```bash
    echo "[install] Plugins: $PLUGIN_INSTALLED installed, $PLUGIN_SKIPPED skipped"
    if [ ${#PLUGIN_DETAIL_LINES[@]} -gt 0 ]; then
        for detail_line in "${PLUGIN_DETAIL_LINES[@]}"; do
            echo "[install] $detail_line"
        done
    fi
    if [ "$PLUGIN_WARNINGS" -gt 0 ]; then
        echo "[install] Plugin warnings: $PLUGIN_WARNINGS"
    fi
    ```

    **Part C: Add warnings recap section**

    After the existing summary "Done." line (line 775), add a dedicated warnings recap section (per user decision — full warning messages repeated):

    ```bash
    echo "[install] Done."

    # Warnings recap (if any)
    if [ ${#PLUGIN_WARNING_MESSAGES[@]} -gt 0 ]; then
        echo ""
        echo "[install] --- Warnings Recap ---"
        for warning in "${PLUGIN_WARNING_MESSAGES[@]}"; do
            echo "[install] WARNING: $warning"
        done
        echo "[install] --- End Warnings ---"
    fi
    ```

    **Part D: Clean up the existing plugin recap section**

    The existing plugin recap section (lines 479-508) now overlaps with the enhanced summary. Since per-plugin details are now stored and replayed in the main summary, the recap section can be simplified or removed to avoid duplication. Per user decision: "Integrate plugin summary into the existing install summary block (not a separate section)."

    Remove the entire "--- Plugin Recap ---" block (lines 479-508). The information it shows (hook registrations, env vars, MCP servers, warnings) will be in the per-plugin detail lines in the main summary.

    If removing feels too aggressive, keep it but add a `# (recap removed — details in summary)` comment. The key point: no duplicate output between recap and summary.
  </action>
  <verify>
    - `bash -n .devcontainer/install-agent-config.sh` passes
    - `grep 'PLUGIN_DETAIL_LINES' .devcontainer/install-agent-config.sh` confirms per-plugin detail storage
    - `grep 'Warnings Recap' .devcontainer/install-agent-config.sh` confirms warnings recap section exists
    - `grep -c 'Plugin Recap' .devcontainer/install-agent-config.sh` returns 0 (old recap removed) or the section is clearly integrated
    - The summary block shows: Plugins line, per-plugin breakdown, warning count, then Done, then Warnings Recap
  </verify>
  <done>
    Install summary shows per-plugin breakdown with counts (hooks, env, commands, agents, MCP). Warning count included in summary. Dedicated warnings recap section appears after "Done." with full warning messages. Old Plugin Recap section removed to avoid duplication. VAL-01, VAL-02, VAL-03, VAL-04 requirements all satisfied.
  </done>
</task>

</tasks>

<verification>
1. `bash -n .devcontainer/install-agent-config.sh` — valid syntax
2. Create a test plugin with an intentionally broken plugin.json, verify friendly error message appears
3. Create a test plugin referencing a non-existent hook script, verify plugin is skipped with warning
4. Create two test plugins with the same hook file name, verify overwrite warning and first-wins behavior
5. Verify warnings recap section appears after "Done." with all accumulated warnings
6. Verify per-plugin breakdown appears in the summary
7. All existing plugins (nmc, frontend-design, plugin-dev, ralph-wiggum) still install correctly
</verification>

<success_criteria>
- Hook script validation catches missing scripts and skips the plugin with clear warning
- File overwrite detection warns and uses first-wins strategy
- Invalid plugin.json shows friendly error then raw parse error
- Empty env vars after hydration produce a warning
- Per-plugin breakdown shown in install summary
- Warnings recap section appears after summary with full messages
- VAL-01, VAL-02, VAL-03, VAL-04 requirements all satisfied
- All existing plugins still install without warnings
</success_criteria>

<output>
After completion, create `.planning/phases/06-langfuse-migration-validation/06-02-SUMMARY.md`
</output>
