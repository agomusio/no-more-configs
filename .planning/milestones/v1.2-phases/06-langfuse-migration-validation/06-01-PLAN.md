---
phase: 06-langfuse-migration-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - agent-config/plugins/langfuse-tracing/plugin.json
  - agent-config/plugins/langfuse-tracing/hooks/langfuse_hook.py
  - agent-config/settings.json.template
  - agent-config/hooks/langfuse_hook.py
  - .devcontainer/install-agent-config.sh
autonomous: true

must_haves:
  truths:
    - "Langfuse tracing plugin exists with valid plugin.json manifest declaring Stop hook"
    - "Langfuse hook fires on Stop event identically to pre-migration behavior"
    - "settings.json.template no longer contains any Langfuse references"
    - "Old hardcoded hook file agent-config/hooks/langfuse_hook.py is deleted"
    - "Plugin env vars with {{TOKEN}} placeholders are hydrated from secrets.json"
    - "User can disable Langfuse via config.json plugins.langfuse-tracing.enabled = false"
  artifacts:
    - path: "agent-config/plugins/langfuse-tracing/plugin.json"
      provides: "Langfuse plugin manifest"
      contains: "langfuse-tracing"
    - path: "agent-config/plugins/langfuse-tracing/hooks/langfuse_hook.py"
      provides: "Langfuse hook script (moved from agent-config/hooks/)"
      min_lines: 100
  key_links:
    - from: "agent-config/plugins/langfuse-tracing/plugin.json"
      to: "agent-config/plugins/langfuse-tracing/hooks/langfuse_hook.py"
      via: "hook command path"
      pattern: "langfuse_hook\\.py"
    - from: ".devcontainer/install-agent-config.sh"
      to: "settings.json"
      via: "plugin env hydration and merge"
      pattern: "hydrate_plugin_env\\|PLUGIN_ENV"
---

<objective>
Migrate Langfuse tracing from hardcoded settings template entries to a self-registering plugin under `agent-config/plugins/langfuse-tracing/`. This is a clean break — the plugin system becomes the only path for Langfuse hook and env registration.

Purpose: Validate the plugin system end-to-end with a real-world migration. The langfuse-tracing plugin becomes the reference implementation for future plugins.

Output: A working langfuse-tracing plugin directory, cleaned settings.json.template, deleted old hook file, and plugin env var hydration in the install script.
</objective>

<execution_context>
@/home/node/.claude/get-shit-done/workflows/execute-plan.md
@/home/node/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-langfuse-migration-validation/06-RESEARCH.md
@.planning/phases/05-mcp-integration/05-01-SUMMARY.md
@agent-config/settings.json.template
@agent-config/hooks/langfuse_hook.py
@agent-config/plugins/nmc/plugin.json
@.devcontainer/install-agent-config.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create langfuse-tracing plugin directory and manifest</name>
  <files>
    agent-config/plugins/langfuse-tracing/plugin.json
    agent-config/plugins/langfuse-tracing/hooks/langfuse_hook.py
    agent-config/hooks/langfuse_hook.py
    agent-config/settings.json.template
  </files>
  <action>
    1. Create directory `agent-config/plugins/langfuse-tracing/hooks/`

    2. Move `agent-config/hooks/langfuse_hook.py` to `agent-config/plugins/langfuse-tracing/hooks/langfuse_hook.py` using `git mv` to preserve history.

    3. Create `agent-config/plugins/langfuse-tracing/plugin.json` with this MINIMAL manifest (per user decision — only declare what Langfuse actually uses, no empty arrays or unused fields):
    ```json
    {
      "name": "langfuse-tracing",
      "version": "1.0.0",
      "description": "Claude Code conversation tracing to Langfuse",
      "hooks": {
        "Stop": [
          {
            "type": "command",
            "command": "python3 /home/node/.claude/hooks/langfuse_hook.py"
          }
        ]
      },
      "env": {
        "TRACE_TO_LANGFUSE": "true",
        "LANGFUSE_HOST": "{{LANGFUSE_HOST}}",
        "LANGFUSE_PUBLIC_KEY": "{{LANGFUSE_PUBLIC_KEY}}",
        "LANGFUSE_SECRET_KEY": "{{LANGFUSE_SECRET_KEY}}"
      }
    }
    ```
    NOTE: The hook command path `/home/node/.claude/hooks/langfuse_hook.py` is the RUNTIME path (where install-agent-config.sh copies plugin hooks to). This is correct — the plugin loop at line 357-363 copies all files from `$plugin_dir/hooks/` to `$CLAUDE_DIR/hooks/`.

    4. Remove ALL Langfuse content from `agent-config/settings.json.template`. The template should keep ONLY the permissions section (additionalDirectories). Remove the entire `env` block and `hooks` block since they were exclusively Langfuse. Result:
    ```json
    {
      "permissions": {
        "additionalDirectories": [
          "/workspace/",
          "/workspace/gitprojects/"
        ],
        "defaultMode": "bypassPermissions"
      }
    }
    ```

    5. Verify the old `agent-config/hooks/langfuse_hook.py` no longer exists (deleted by git mv).
  </action>
  <verify>
    - `test -f agent-config/plugins/langfuse-tracing/plugin.json` succeeds
    - `test -f agent-config/plugins/langfuse-tracing/hooks/langfuse_hook.py` succeeds
    - `test ! -f agent-config/hooks/langfuse_hook.py` succeeds (old file deleted)
    - `jq -e '.name == "langfuse-tracing"' agent-config/plugins/langfuse-tracing/plugin.json` succeeds
    - `jq -e '.hooks.Stop' agent-config/plugins/langfuse-tracing/plugin.json` returns the Stop hook array
    - `jq -e '.env.TRACE_TO_LANGFUSE' agent-config/plugins/langfuse-tracing/plugin.json` returns "true"
    - `grep -c 'langfuse\|LANGFUSE' agent-config/settings.json.template` returns 0 (no Langfuse references)
    - `jq -e '.permissions' agent-config/settings.json.template` succeeds (permissions preserved)
  </verify>
  <done>
    Langfuse-tracing plugin exists with valid plugin.json declaring Stop hook and 4 env vars. Old hook file deleted. Settings template contains only permissions, no Langfuse references.
  </done>
</task>

<task type="auto">
  <name>Task 2: Clean up install script and add plugin env var hydration</name>
  <files>.devcontainer/install-agent-config.sh</files>
  <action>
    This task removes hardcoded Langfuse variable extraction from the install script and adds a generic plugin env var hydration mechanism so `{{TOKEN}}` placeholders in plugin env values get resolved.

    **Part A: Remove hardcoded Langfuse variable extraction**

    1. Remove the Langfuse-specific variables from the secrets.json loading section (lines 66-83):
       - Remove `LANGFUSE_PUBLIC_KEY` extraction from secrets.json (line 66-67)
       - Remove `LANGFUSE_SECRET_KEY` extraction from secrets.json
       - Remove the empty-key warnings (lines 70-75)
       - Remove the fallback empty assignments (lines 77-78, 82-83)
       NOTE: Keep `LANGFUSE_HOST` extraction from config.json (line 50) — it's still used for other things (infra env generation uses it). Actually wait — check if it is. If LANGFUSE_HOST is ONLY used for settings template hydration (line 280), then remove it too. If it's used elsewhere (e.g., langfuse-setup or infra), keep it.

    2. Check if LANGFUSE_HOST is used anywhere besides the settings template hydration (line 280-283). If not, remove lines 50-59 that extract it from config.json. If it IS used elsewhere, keep them.

    3. Update the settings template hydration section (lines 278-288). After Langfuse removal, the template no longer has `{{LANGFUSE_*}}` tokens. Simplify the sed command to not reference Langfuse tokens. If the template has NO remaining `{{TOKEN}}` patterns, the sed command becomes a simple `cat`:
       ```bash
       if [ -f "$SETTINGS_TEMPLATE" ]; then
           HYDRATED_SETTINGS=$(cat "$SETTINGS_TEMPLATE")
           echo "[install] Loaded settings template (will merge into settings.json)"
       else
           HYDRATED_SETTINGS='{}'
           echo "[install] WARNING: settings.json.template not found — skipping settings generation"
       fi
       ```

    **Part B: Add plugin env var hydration**

    After plugin loop completes (after line 471 `done`) and before the plugin recap section, add a hydration step for plugin env vars. This resolves `{{TOKEN}}` placeholders in PLUGIN_ENV values using the same namespaced secret lookup pattern from Phase 5's MCP hydration:

    Add a `hydrate_plugin_env()` function near the existing `hydrate_plugin_mcp()` function (around line 573). Pattern:

    ```bash
    # Hydrate {{TOKEN}} placeholders in plugin env vars from secrets.json
    # Uses per-plugin namespaced lookup: secrets.json[plugin-name][TOKEN]
    # Requires PLUGIN_ENV_SOURCES associative array mapping env keys to plugin names
    hydrate_plugin_env() {
        local plugin_env="$1"
        local secrets_file="$2"
        local hydrated="$plugin_env"

        # Find all {{TOKEN}} patterns in env values
        local tokens
        tokens=$(echo "$plugin_env" | grep -oP '\{\{[A-Z_]+\}\}' | sort -u || true)

        for token_pattern in $tokens; do
            local token_name
            token_name=$(echo "$token_pattern" | sed 's/{{//;s/}}//')

            # Try each plugin namespace in secrets.json
            local secret_value=""
            if [ -f "$secrets_file" ]; then
                # Iterate known plugin names to find the secret
                for p_name in $(echo "$plugin_env" | jq -r 'to_entries[] | select(.value | test("\\{\\{")) | .value' 2>/dev/null | grep -oP '\{\{[A-Z_]+\}\}' | sort -u | head -1 > /dev/null; echo "$plugin_env" | jq -r 'keys[]' 2>/dev/null || true); do
                    :  # This approach is too complex
                done
            fi
        done

        echo "$hydrated"
    }
    ```

    ACTUALLY — simpler approach. Instead of a complex function, do per-plugin env hydration DURING accumulation. In the plugin loop, right after extracting MANIFEST_ENV (line 405), hydrate any `{{TOKEN}}` patterns before merging into PLUGIN_ENV:

    After line 405 (`MANIFEST_ENV=$(jq -r '.env // {}' "$MANIFEST" 2>/dev/null)`), add:

    ```bash
    # Hydrate {{TOKEN}} placeholders in this plugin's env from secrets.json
    if [ "$MANIFEST_ENV" != "{}" ] && [ "$MANIFEST_ENV" != "null" ] && [ -f "$SECRETS_FILE" ]; then
        env_tokens=$(echo "$MANIFEST_ENV" | grep -oP '\{\{[A-Z_]+\}\}' | sort -u || true)
        for token_pattern in $env_tokens; do
            token_name=$(echo "$token_pattern" | sed 's/{{//;s/}}//')
            # Namespaced lookup: secrets.json[plugin-name][TOKEN]
            secret_value=$(jq -r --arg p "$plugin_name" --arg k "$token_name" \
                '.[$p][$k] // ""' "$SECRETS_FILE" 2>/dev/null || echo "")
            if [ -n "$secret_value" ]; then
                MANIFEST_ENV=$(echo "$MANIFEST_ENV" | jq --arg token "$token_pattern" --arg value "$secret_value" \
                    'to_entries | map(if .value == $token then .value = $value else . end) | from_entries' 2>/dev/null || echo "$MANIFEST_ENV")
            fi
        done
    fi
    ```

    This approach:
    - Runs per-plugin during accumulation while we know the plugin_name
    - Uses `secrets.json[plugin-name][TOKEN]` for namespaced lookup (same pattern as MCP hydration)
    - Handles partial hydration (some tokens found, some not)
    - Non-hydrated `{{TOKEN}}` values will be caught by the existing unresolved placeholder detection at line 675-689

    **Part C: Handle config.json env overrides for Langfuse**

    The existing config.json override mechanism at lines 424-432 already works. Users can put `"plugins": {"langfuse-tracing": {"env": {"LANGFUSE_HOST": "http://custom:3050"}}}` in config.json and it overrides the plugin value. No changes needed here.

    However, ensure that `config.json.langfuse.host` is still respected if present. Add a fallback: during plugin env hydration, if the namespaced secret lookup for LANGFUSE_HOST fails, try reading from `config.json.langfuse.host`. This ensures backward compatibility.

    Actually — this adds complexity. Simpler: the user documents `secrets.json["langfuse-tracing"]["LANGFUSE_HOST"]` as the canonical path. Or they use `config.json.plugins.langfuse-tracing.env.LANGFUSE_HOST` override. The old `config.json.langfuse.host` path is deprecated. Add an inline note in the code.
  </action>
  <verify>
    - `bash -n .devcontainer/install-agent-config.sh` passes (valid bash syntax)
    - `grep -c 'LANGFUSE_PUBLIC_KEY\|LANGFUSE_SECRET_KEY' .devcontainer/install-agent-config.sh` returns 0 or only appears in comments (no hardcoded extraction)
    - `grep 'env_tokens.*grep.*TOKEN' .devcontainer/install-agent-config.sh` confirms plugin env hydration exists
    - `grep 'secrets.json.*plugin.*TOKEN' .devcontainer/install-agent-config.sh` or similar confirms namespaced lookup
    - The sed command for settings template hydration no longer references LANGFUSE tokens
  </verify>
  <done>
    Install script no longer has hardcoded Langfuse variable extraction. Plugin env vars with {{TOKEN}} placeholders are hydrated per-plugin from secrets.json[plugin-name][TOKEN] during accumulation. Settings template hydration is simplified. Backward compatibility maintained via config.json plugin env override mechanism.
  </done>
</task>

</tasks>

<verification>
1. `bash -n .devcontainer/install-agent-config.sh` — valid syntax
2. `jq empty agent-config/plugins/langfuse-tracing/plugin.json` — valid JSON
3. `test ! -f agent-config/hooks/langfuse_hook.py` — old file deleted
4. `grep -c 'LANGFUSE' agent-config/settings.json.template` — returns 0
5. The plugin system discovers langfuse-tracing and registers its Stop hook and 4 env vars
6. Disabling the plugin in config.json (`"plugins": {"langfuse-tracing": {"enabled": false}}`) skips all Langfuse registration
</verification>

<success_criteria>
- Langfuse-tracing plugin directory exists with valid plugin.json and hooks/langfuse_hook.py
- settings.json.template contains no Langfuse references
- Old agent-config/hooks/langfuse_hook.py is deleted
- Install script has no hardcoded Langfuse secret extraction
- Plugin env var {{TOKEN}} placeholders are hydrated from namespaced secrets.json
- LANG-01 through LANG-05 requirements are all satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/06-langfuse-migration-validation/06-01-SUMMARY.md`
</output>
