---
phase: 05-mcp-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .devcontainer/install-agent-config.sh
  - .devcontainer/mcp-setup-bin.sh
autonomous: true

must_haves:
  truths:
    - "Plugin MCP servers declared in plugin.json appear in ~/.claude/.mcp.json after install"
    - "{{TOKEN}} placeholders in plugin MCP configs are hydrated from secrets.json using plugin-namespaced lookups"
    - "Plugin MCP servers persist when mcp-setup runs in postStartCommand"
    - "Missing secret tokens produce inline warnings without crashing install script"
    - "Disabled plugins have no MCP servers in .mcp.json"
    - "Each plugin MCP server entry has _source metadata tag for traceability"
  artifacts:
    - path: ".devcontainer/install-agent-config.sh"
      provides: "PLUGIN_MCP accumulator, hydrate_plugin_mcp function, unified .mcp.json generation with plugin + base servers"
      contains: "hydrate_plugin_mcp"
    - path: ".devcontainer/mcp-setup-bin.sh"
      provides: "Plugin server preservation during postStartCommand regeneration"
      contains: "_source"
  key_links:
    - from: "install-agent-config.sh plugin loop"
      to: "PLUGIN_MCP accumulator"
      via: "jq merge with _source tagging"
      pattern: "_source.*plugin:"
    - from: "install-agent-config.sh hydrate_plugin_mcp"
      to: "secrets.json"
      via: "namespaced jq lookup"
      pattern: '\.\[\$p\]\[\$k\]'
    - from: "install-agent-config.sh .mcp.json generation"
      to: "PLUGIN_MCP + base template servers"
      via: "unified write combining plugin and base servers"
      pattern: "HYDRATED_PLUGIN_MCP"
    - from: "mcp-setup-bin.sh"
      to: "existing .mcp.json plugin entries"
      via: "preserve entries with _source tag starting with plugin:"
      pattern: 'startswith\("plugin:"\)'
---

<objective>
Add plugin MCP server accumulation, secret token hydration, and unified .mcp.json generation to the install script, then update mcp-setup to preserve plugin entries.

Purpose: Plugins can declare MCP servers in plugin.json that auto-register in ~/.claude/.mcp.json with secrets hydrated from secrets.json, persisting across container rebuilds.

Output: Modified install-agent-config.sh with PLUGIN_MCP accumulation + hydration + unified .mcp.json write; modified mcp-setup-bin.sh that preserves plugin-tagged servers.
</objective>

<execution_context>
@/home/node/.claude/get-shit-done/workflows/execute-plan.md
@/home/node/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-core-plugin-system/04-02-SUMMARY.md
@.planning/phases/04-core-plugin-system/04-03-SUMMARY.md
@.planning/phases/05-mcp-integration/05-RESEARCH.md
@.devcontainer/install-agent-config.sh
@.devcontainer/mcp-setup-bin.sh
@.planning/nmc-plugin-spec.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add plugin MCP accumulation, hydration, and unified .mcp.json generation</name>
  <files>.devcontainer/install-agent-config.sh</files>
  <action>
Three changes to install-agent-config.sh:

**1. Initialize PLUGIN_MCP accumulator (line ~43, with other accumulators):**
Add `PLUGIN_MCP='{}'` alongside existing PLUGIN_HOOKS, PLUGIN_ENV, PLUGIN_WARNINGS initializers.

**2. Accumulate MCP servers in plugin loop (after env accumulation, around line 432):**
After the environment variable accumulation block and before the per-plugin detail logging, add MCP server accumulation:

```bash
# Accumulate MCP servers with source tagging
MANIFEST_MCP=$(jq -r '.mcp_servers // {}' "$MANIFEST" 2>/dev/null || echo "{}")
if [ "$MANIFEST_MCP" != "{}" ] && [ "$MANIFEST_MCP" != "null" ]; then
    # Tag each server with _source for traceability
    TAGGED_MCP=$(echo "$MANIFEST_MCP" | jq --arg plugin "$plugin_name" '
        to_entries | map(.value._source = "plugin:\($plugin)") | from_entries
    ' 2>/dev/null || echo "{}")
    if [ "$TAGGED_MCP" != "{}" ]; then
        PLUGIN_MCP=$(jq -n --argjson acc "$PLUGIN_MCP" --argjson new "$TAGGED_MCP" \
            '$acc * $new' 2>/dev/null || echo "$PLUGIN_MCP")
    fi
fi
```

Also update the per-plugin detail logging to count MCP servers:
```bash
plugin_mcp_count=$(echo "$MANIFEST_MCP" | jq 'if . == {} or . == null then 0 else length end' 2>/dev/null || echo "0")
[ "$plugin_mcp_count" -gt 0 ] && detail_parts+=("${plugin_mcp_count} MCP server(s)")
```

**3. Add hydrate_plugin_mcp function and modify .mcp.json generation:**

Add a `hydrate_plugin_mcp()` function BEFORE the ".mcp.json generation" section (before the comment "# Generate .mcp.json from enabled MCP templates"). The function:

```bash
# Hydrate {{TOKEN}} placeholders in plugin MCP configs from secrets.json
hydrate_plugin_mcp() {
    local plugin_mcp="$1"
    local secrets_file="$2"
    local hydrated="$plugin_mcp"

    # Iterate over each server to hydrate per-plugin secrets
    local servers
    servers=$(echo "$plugin_mcp" | jq -r 'keys[]' 2>/dev/null || true)

    for server in $servers; do
        # Get plugin name from _source tag
        local p_name
        p_name=$(echo "$plugin_mcp" | jq -r --arg s "$server" '.[$s]._source // "" | sub("^plugin:"; "")' 2>/dev/null || echo "")
        [ -z "$p_name" ] && continue

        # Extract {{TOKEN}} patterns from this server's config
        local server_json
        server_json=$(echo "$plugin_mcp" | jq --arg s "$server" '.[$s]' 2>/dev/null || echo "{}")
        local server_tokens
        server_tokens=$(echo "$server_json" | grep -oP '\{\{[A-Z_]+\}\}' | sort -u || true)

        for token_pattern in $server_tokens; do
            local token_name
            token_name=$(echo "$token_pattern" | sed 's/{{//;s/}}//')

            # Namespaced lookup: secrets.json["plugin-name"]["TOKEN_NAME"]
            local secret_value=""
            if [ -f "$secrets_file" ]; then
                secret_value=$(jq -r --arg p "$p_name" --arg k "$token_name" \
                    '.[$p][$k] // ""' "$secrets_file" 2>/dev/null || echo "")
            fi

            # Warn if missing (per user decision: inline warning, no crash)
            if [ -z "$secret_value" ]; then
                echo "⚠ $p_name: missing $token_name"
            fi

            # Hydrate using jq walk+gsub (safe for special characters in secrets)
            hydrated=$(echo "$hydrated" | jq \
                --arg token "$token_pattern" \
                --arg value "$secret_value" \
                'walk(if type == "string" then gsub($token; $value) else . end)' 2>/dev/null || echo "$hydrated")
        done
    done

    echo "$hydrated"
}
```

Then REPLACE the existing .mcp.json generation block (lines 547-581, from "# Generate .mcp.json from enabled MCP templates" through the final else/fi that writes the default) with a unified generation that includes plugin servers FIRST, then base template servers:

```bash
# Generate .mcp.json — unified: plugin servers (hydrated) + base template servers
MCP_JSON='{"mcpServers":{}}'

# Step 1: Add hydrated plugin MCP servers
if [ "$PLUGIN_MCP" != "{}" ]; then
    HYDRATED_PLUGIN_MCP=$(hydrate_plugin_mcp "$PLUGIN_MCP" "$SECRETS_FILE")
    MCP_JSON=$(echo "$MCP_JSON" | jq --argjson plugin "$HYDRATED_PLUGIN_MCP" \
        '.mcpServers = $plugin')
    PLUGIN_MCP_COUNT=$(echo "$HYDRATED_PLUGIN_MCP" | jq 'length' 2>/dev/null || echo "0")
    MCP_COUNT=$((MCP_COUNT + PLUGIN_MCP_COUNT))
fi

# Step 2: Add base template servers from config.json
if [ -f "$CONFIG_FILE" ]; then
    ENABLED_SERVERS=$(jq -r '.mcp_servers | to_entries[] | select(.value.enabled == true) | .key' "$CONFIG_FILE" 2>/dev/null || echo "")

    if [ -n "$ENABLED_SERVERS" ]; then
        for SERVER in $ENABLED_SERVERS; do
            TEMPLATE_FILE="$MCP_TEMPLATES_DIR/${SERVER}.json"
            if [ -f "$TEMPLATE_FILE" ]; then
                HYDRATED=$(sed "s|{{MCP_GATEWAY_URL}}|$MCP_GATEWAY_URL|g" "$TEMPLATE_FILE")
                MCP_JSON=$(echo "$MCP_JSON" | jq --argjson server "{\"$SERVER\": $HYDRATED}" '.mcpServers += $server')
                MCP_COUNT=$((MCP_COUNT + 1))
            else
                echo "[install] WARNING: Template $TEMPLATE_FILE not found for enabled server $SERVER"
            fi
        done
    fi
fi

# Fallback: if no servers at all, add default mcp-gateway
SERVER_COUNT=$(echo "$MCP_JSON" | jq '.mcpServers | length')
if [ "$SERVER_COUNT" -eq 0 ]; then
    MCP_JSON='{"mcpServers":{"mcp-gateway":{"type":"sse","url":"'"$MCP_GATEWAY_URL"'/sse"}}}'
    MCP_COUNT=1
fi

echo "$MCP_JSON" > "$CLAUDE_DIR/.mcp.json"
echo "[install] Generated .mcp.json with $MCP_COUNT server(s)"
```

Also add MCP server count to the Plugin Recap block (after the env var count line):
```bash
# Count total plugin MCP servers
TOTAL_PLUGIN_MCP=0
if [ "$PLUGIN_MCP" != "{}" ]; then
    TOTAL_PLUGIN_MCP=$(echo "$PLUGIN_MCP" | jq 'length' 2>/dev/null || echo "0")
fi
echo "[install] Plugin MCP servers: $TOTAL_PLUGIN_MCP"
```

**Discretion decisions (Claude's Discretion areas from CONTEXT.md):**
- Token placeholder format: Use `{{TOKEN}}` — matches existing settings.json.template pattern, avoids shell expansion
- Missing vs empty secret: Treat both as "missing" (empty string) — practical, no distinction needed
- All secrets missing: Same behavior as partial — register server with raw placeholders, warn per token
- MCP config structure in plugin.json: Use `mcp_servers` key (object of server configs, matching nmc-plugin-spec.md)
  </action>
  <verify>
1. `bash -n .devcontainer/install-agent-config.sh` — syntax check passes
2. `grep -c 'PLUGIN_MCP' .devcontainer/install-agent-config.sh` — at least 8 references (init, accumulate, hydrate call, merge, count, recap)
3. `grep 'hydrate_plugin_mcp' .devcontainer/install-agent-config.sh` — function defined and called
4. `grep '_source' .devcontainer/install-agent-config.sh` — source tagging present
5. `grep '⚠.*missing' .devcontainer/install-agent-config.sh` — inline warning for missing secrets
6. `grep -c 'SECRETS_FILE' .devcontainer/install-agent-config.sh` — secrets.json referenced in hydration
7. Verify the old .mcp.json generation block is replaced (no duplicate MCP generation logic)
  </verify>
  <done>
- PLUGIN_MCP accumulator initialized and populated in plugin loop with _source tagging
- hydrate_plugin_mcp function performs per-server, per-token namespaced secret lookup from secrets.json
- Missing secrets print inline warning (e.g., "⚠ langfuse-tracing: missing SECRET_KEY") without crashing
- .mcp.json generated in single unified write: plugin servers (hydrated) + base template servers
- Disabled plugins excluded naturally (plugin loop skips them before accumulation)
- Plugin Recap includes MCP server count
- Per-plugin detail logging shows MCP server count
  </done>
</task>

<task type="auto">
  <name>Task 2: Update mcp-setup to preserve plugin-tagged MCP servers</name>
  <files>.devcontainer/mcp-setup-bin.sh</files>
  <action>
Modify mcp-setup-bin.sh so that when it regenerates .mcp.json (in postStartCommand), it preserves plugin-tagged entries that install-agent-config.sh wrote. Currently, mcp-setup overwrites .mcp.json from scratch (lines 14-41), which would destroy plugin MCP servers.

Replace the .mcp.json generation section (lines 12-41) with:

```bash
mkdir -p "$claude_dir"

# Load existing .mcp.json (written by install-agent-config.sh, may contain plugin servers)
EXISTING_MCP=$(cat "$claude_dir/.mcp.json" 2>/dev/null || echo '{"mcpServers":{}}')

# Extract and preserve plugin servers (identified by _source tag starting with "plugin:")
PLUGIN_SERVERS=$(echo "$EXISTING_MCP" | jq '.mcpServers |
    with_entries(select(.value._source? // "" | startswith("plugin:")))' 2>/dev/null || echo '{}')

PLUGIN_COUNT=$(echo "$PLUGIN_SERVERS" | jq 'length' 2>/dev/null || echo "0")

# Build base servers from config.json templates (refreshed each start)
MCP_JSON='{"mcpServers":{}}'
MCP_COUNT=0

if [ -f "$config_file" ]; then
    ENABLED_SERVERS=$(jq -r '.mcp_servers | to_entries[] | select(.value.enabled == true) | .key' "$config_file" 2>/dev/null || echo "")

    if [ -n "$ENABLED_SERVERS" ]; then
        for SERVER in $ENABLED_SERVERS; do
            TEMPLATE_FILE="${templates_dir}/${SERVER}.json"
            if [ -f "$TEMPLATE_FILE" ]; then
                HYDRATED=$(sed "s|{{MCP_GATEWAY_URL}}|$gateway_url|g" "$TEMPLATE_FILE")
                MCP_JSON=$(echo "$MCP_JSON" | jq --argjson server "{\"$SERVER\": $HYDRATED}" '.mcpServers += $server')
                MCP_COUNT=$((MCP_COUNT + 1))
            else
                echo "⚠ Template not found: $TEMPLATE_FILE"
            fi
        done
    fi
fi

# Merge: plugin servers (preserved from install) + base servers (refreshed)
# Plugin servers take precedence (they are plugin-owned)
FINAL_MCP=$(jq -n --argjson plugins "$PLUGIN_SERVERS" --argjson base "$MCP_JSON" \
    '{mcpServers: ($plugins + $base.mcpServers)}')

# Fallback: if no servers at all, add default mcp-gateway
TOTAL_COUNT=$(echo "$FINAL_MCP" | jq '.mcpServers | length')
if [ "$TOTAL_COUNT" -eq 0 ]; then
    FINAL_MCP='{"mcpServers":{"mcp-gateway":{"type":"sse","url":"'"$gateway_url"'/sse"}}}'
    TOTAL_COUNT=1
fi

echo "$FINAL_MCP" | jq '.' > "${claude_dir}/.mcp.json"

if [ "$PLUGIN_COUNT" -gt 0 ]; then
    echo "✓ Generated ${claude_dir}/.mcp.json with $TOTAL_COUNT server(s) ($PLUGIN_COUNT plugin, $MCP_COUNT base)"
else
    echo "✓ Generated ${claude_dir}/.mcp.json with $TOTAL_COUNT server(s)"
fi
```

The rest of the file (health check, status output) stays unchanged.
  </action>
  <verify>
1. `bash -n .devcontainer/mcp-setup-bin.sh` — syntax check passes (note: uses /bin/sh, test with `sh -n` too)
2. `grep '_source' .devcontainer/mcp-setup-bin.sh` — preserves plugin entries by _source tag
3. `grep 'PLUGIN_SERVERS' .devcontainer/mcp-setup-bin.sh` — plugin server extraction present
4. `grep 'EXISTING_MCP' .devcontainer/mcp-setup-bin.sh` — loads existing .mcp.json before regeneration
5. `grep 'startswith("plugin:")' .devcontainer/mcp-setup-bin.sh` — filters by plugin source tag
6. Verify no standalone `MCP_JSON=.*> "${claude_dir}/.mcp.json"` that would overwrite without merging plugins
  </verify>
  <done>
- mcp-setup reads existing .mcp.json before regenerating
- Plugin servers (identified by _source tag) are extracted and preserved
- Base template servers are regenerated fresh from config.json
- Final .mcp.json = plugin servers + base servers merged
- Plugin servers take precedence over base servers with same name
- Output message shows plugin and base server counts when plugins present
- Empty state handled with fallback to default mcp-gateway
  </done>
</task>

</tasks>

<verification>
1. `bash -n .devcontainer/install-agent-config.sh` — no syntax errors
2. `bash -n .devcontainer/mcp-setup-bin.sh` — no syntax errors
3. Verify MCP-01: `grep 'PLUGIN_MCP' .devcontainer/install-agent-config.sh | head -5` — accumulation exists
4. Verify MCP-02: `grep 'hydrate_plugin_mcp' .devcontainer/install-agent-config.sh` — hydration function exists and is called
5. Verify MCP-03: `grep 'PLUGIN_SERVERS' .devcontainer/mcp-setup-bin.sh` — preservation logic exists
6. Verify MCP-04: `grep '⚠' .devcontainer/install-agent-config.sh` — missing secret warning exists
7. Verify source tagging: `grep '_source' .devcontainer/install-agent-config.sh .devcontainer/mcp-setup-bin.sh` — both files reference _source
</verification>

<success_criteria>
- MCP-01: Plugin MCP servers from plugin.json mcp_servers field are accumulated with _source tagging and merged into .mcp.json
- MCP-02: {{PLACEHOLDER}} tokens are hydrated from secrets.json using plugin-namespaced lookups (secrets.json["plugin-name"]["TOKEN"])
- MCP-03: mcp-setup-bin.sh preserves plugin-tagged entries and only refreshes base template servers
- MCP-04: Missing secret tokens produce inline warning "⚠ plugin-name: missing TOKEN_NAME" without crashing
- Both scripts pass bash syntax validation
- Plugin Recap section shows MCP server count
</success_criteria>

<output>
After completion, create `.planning/phases/05-mcp-integration/05-01-SUMMARY.md`
</output>
