---
phase: 04-core-plugin-system
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - .devcontainer/install-agent-config.sh
autonomous: true

must_haves:
  truths:
    - "Plugin directories under agent-config/plugins/ are discovered and processed in alphabetical order"
    - "plugin.json manifest is validated for existence, valid JSON, and name matching directory name"
    - "Plugins not mentioned in config.json are enabled by default"
    - "Plugins set to enabled:false in config.json are fully skipped with info message"
    - "Plugin skills, hooks, commands, and agents are copied to ~/.claude/ runtime directories"
    - "Plugin skills are also copied to ~/.codex/skills/ (cross-agent)"
    - "GSD files (agents/gsd-*.md, commands/gsd/) are never overwritten by plugin copies"
    - "Missing/invalid plugin.json causes clean skip with no files copied"
    - "Per-plugin detail log shows what was installed (hooks, skills, env vars, commands, agents)"
  artifacts:
    - path: ".devcontainer/install-agent-config.sh"
      provides: "Plugin discovery loop, validation, file copying with GSD protection"
      contains: "agent-config/plugins"
  key_links:
    - from: ".devcontainer/install-agent-config.sh"
      to: "~/.claude/skills/, ~/.claude/hooks/, ~/.claude/commands/, ~/.claude/agents/"
      via: "cp operations within plugin loop"
      pattern: "plugin_dir.*skills|plugin_dir.*hooks|plugin_dir.*commands|plugin_dir.*agents"
    - from: ".devcontainer/install-agent-config.sh"
      to: "config.json"
      via: "jq reading .plugins[name].enabled"
      pattern: "plugins.*enabled"
---

<objective>
Implement plugin discovery, validation, and file copying in install-agent-config.sh.

Purpose: This is the core plugin installation loop. It discovers plugin directories, validates their manifests, checks enable/disable state from config.json, copies their files (skills, hooks, commands, agents) to runtime directories with GSD protection, and logs per-plugin detail. It also initializes accumulator variables for hook and env var registrations that will be merged in Plan 03.

Output: Updated `install-agent-config.sh` with complete plugin discovery and file copying logic.
</objective>

<execution_context>
@/home/node/.claude/get-shit-done/workflows/execute-plan.md
@/home/node/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-core-plugin-system/04-CONTEXT.md
@.planning/phases/04-core-plugin-system/04-RESEARCH.md
@.planning/phases/04-core-plugin-system/04-01-SUMMARY.md
@.devcontainer/install-agent-config.sh
@.planning/nmc-plugin-spec.md
@agent-config/settings.json.template
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement plugin discovery loop with validation</name>
  <files>.devcontainer/install-agent-config.sh</files>
  <action>
Add the plugin discovery and validation section to `install-agent-config.sh`. Insert this AFTER the settings.json seed section (~line 253 after Plan 01 changes) and BEFORE credential restoration. This placement ensures plugins install after settings.local.json exists (needed for hook/env merging in Plan 03) but before GSD installation (which must be last to protect its files).

**Initialize counters and accumulators (near other counter initializations, ~line 30-36 area):**

```
PLUGIN_INSTALLED=0
PLUGIN_SKIPPED=0
PLUGIN_HOOKS='{}'
PLUGIN_ENV='{}'
PLUGIN_WARNINGS=0
```

**Plugin installation section:**

Add a clearly commented section `# --- Plugin Installation ---` that:

1. **Checks for plugins directory:** `if [ -d "$AGENT_CONFIG_DIR/plugins" ]; then`

2. **Iterates plugins in alphabetical order:** `for plugin_dir in "$AGENT_CONFIG_DIR/plugins"/*/; do`
   - Guard: `[ -d "$plugin_dir" ] || continue`
   - Extract: `plugin_name=$(basename "$plugin_dir")`

3. **Check enabled/disabled in config.json** (PLUG-04, PLUG-05):
   - Read: `jq -r --arg name "$plugin_name" '.plugins[$name].enabled // true' "$CONFIG_FILE"` with fallback to `"true"`
   - If `"false"`: log `"[install] Plugin '$plugin_name': skipped (disabled)"`, increment `PLUGIN_SKIPPED`, `continue`

4. **Validate plugin.json exists** (PLUG-02, PLUG-03):
   - Check: `if [ ! -f "$MANIFEST" ]; then` log info-style skip message, `continue`

5. **Validate plugin.json is valid JSON** (PLUG-02):
   - Use existing `validate_json` function: `if ! validate_json "$MANIFEST" "plugins/$plugin_name/plugin.json"; then continue; fi`

6. **Validate plugin name matches directory** (per user decision):
   - Read: `manifest_name=$(jq -r '.name // ""' "$MANIFEST" 2>/dev/null)`
   - Compare: `if [ "$manifest_name" != "$plugin_name" ]; then` log warning with both names, increment PLUGIN_WARNINGS, `continue`

7. **At this point, plugin is valid and enabled. Proceed to file copying (Task 2).**

The loop structure should be clean and readable. Use comments to separate each validation step. Match the existing script's style of `[install]` prefixed messages.

Per user decisions (LOCKED):
- Skipped plugins use info-style: `"[install] Plugin 'name': skipped (disabled)"` NOT warning
- Missing plugin.json: skip with info message, no files copied
- Name mismatch: warning + skip
  </action>
  <verify>
Run: `bash -n .devcontainer/install-agent-config.sh` to verify no syntax errors.
Grep for "PLUGIN_INSTALLED\|PLUGIN_SKIPPED\|PLUGIN_HOOKS\|PLUGIN_ENV" to confirm accumulators initialized.
Grep for "plugins/\*/" to confirm plugin directory iteration.
Grep for "manifest_name" to confirm name validation.
  </verify>
  <done>
- Plugin discovery iterates `agent-config/plugins/*/` in alphabetical order (PLUG-01, PLUG-06)
- plugin.json existence and JSON validity are checked (PLUG-02, PLUG-03)
- Plugins not in config.json default to enabled (PLUG-04)
- Disabled plugins are fully skipped with info message (PLUG-05)
- Plugin name vs directory name mismatch causes skip with warning
- Accumulator variables initialized for hooks and env vars
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement plugin file copying with GSD protection</name>
  <files>.devcontainer/install-agent-config.sh</files>
  <action>
Add file copying logic INSIDE the plugin loop (after validation, before accumulator updates). This task adds the file copy operations and per-plugin install detail logging.

**For each valid, enabled plugin, copy files with these rules:**

1. **Skills** (COPY-01, cross-agent):
   ```bash
   if [ -d "$plugin_dir/skills" ]; then
       cp -r "$plugin_dir/skills/"* "$CLAUDE_DIR/skills/" 2>/dev/null || true
       cp -r "$plugin_dir/skills/"* /home/node/.codex/skills/ 2>/dev/null || true
       plugin_skills=$(find "$plugin_dir/skills" -maxdepth 1 -mindepth 1 -type d 2>/dev/null | wc -l)
   fi
   ```

2. **Hooks** (COPY-02):
   ```bash
   if [ -d "$plugin_dir/hooks" ]; then
       for hook_file in "$plugin_dir/hooks"/*; do
           [ -f "$hook_file" ] || continue
           cp "$hook_file" "$CLAUDE_DIR/hooks/"
       done
       plugin_hooks_count=$(find "$plugin_dir/hooks" -maxdepth 1 -type f 2>/dev/null | wc -l)
   fi
   ```

3. **Commands** (COPY-03, COPY-05 — GSD protection):
   ```bash
   if [ -d "$plugin_dir/commands" ]; then
       # Check for GSD directory conflict
       if [ -d "$plugin_dir/commands/gsd" ]; then
           echo "[install] ERROR: Plugin '$plugin_name' attempted to overwrite GSD-protected directory commands/gsd/ -- skipping"
           PLUGIN_WARNINGS=$((PLUGIN_WARNINGS + 1))
       fi
       for cmd_file in "$plugin_dir/commands"/*.md; do
           [ -f "$cmd_file" ] || continue
           cp "$cmd_file" "$CLAUDE_DIR/commands/"
       done
       plugin_cmds=$(find "$plugin_dir/commands" -maxdepth 1 -name "*.md" -type f 2>/dev/null | wc -l)
   fi
   ```

4. **Agents** (COPY-04, COPY-05 — GSD protection):
   ```bash
   if [ -d "$plugin_dir/agents" ]; then
       for agent_file in "$plugin_dir/agents"/*.md; do
           [ -f "$agent_file" ] || continue
           agent_name=$(basename "$agent_file")
           if [[ "$agent_name" =~ ^gsd- ]]; then
               echo "[install] ERROR: Plugin '$plugin_name' attempted to overwrite GSD-protected file agents/$agent_name -- skipping"
               PLUGIN_WARNINGS=$((PLUGIN_WARNINGS + 1))
               continue
           fi
           cp "$agent_file" "$CLAUDE_DIR/agents/"
       done
       plugin_agents=$(find "$plugin_dir/agents" -maxdepth 1 -name "*.md" -type f 2>/dev/null | wc -l)
   fi
   ```

**Accumulate hook registrations** (for merge in Plan 03):

Read hooks from manifest and merge into PLUGIN_HOOKS accumulator using jq array concatenation (`+` operator, NOT `*`). Use the pattern from RESEARCH.md:
```bash
MANIFEST_HOOKS=$(jq -r '.hooks // {}' "$MANIFEST" 2>/dev/null)
if [ "$MANIFEST_HOOKS" != "{}" ] && [ "$MANIFEST_HOOKS" != "null" ]; then
    PLUGIN_HOOKS=$(jq -n --argjson acc "$PLUGIN_HOOKS" --argjson new "$MANIFEST_HOOKS" '
        $new | to_entries | reduce .[] as $entry ($acc;
            .[$entry.key] = ((.[$entry.key] // []) + $entry.value)
        )
    ' 2>/dev/null || echo "$PLUGIN_HOOKS")
fi
```

**Accumulate environment variables** (for merge in Plan 03):

Read env from manifest, check for conflicts with already-accumulated env vars (first-alphabetically wins per user decision), then apply config.json overrides:
```bash
MANIFEST_ENV=$(jq -r '.env // {}' "$MANIFEST" 2>/dev/null)
if [ "$MANIFEST_ENV" != "{}" ] && [ "$MANIFEST_ENV" != "null" ]; then
    # Check for conflicts: any key in MANIFEST_ENV that already exists in PLUGIN_ENV
    CONFLICTS=$(jq -n --argjson existing "$PLUGIN_ENV" --argjson new "$MANIFEST_ENV" '
        [$new | keys[] | select(. as $k | $existing | has($k))]
    ' 2>/dev/null)
    if [ "$CONFLICTS" != "[]" ] && [ -n "$CONFLICTS" ]; then
        echo "[install] WARNING: Plugin '$plugin_name' env var conflict: $CONFLICTS -- using earlier plugin's values"
        PLUGIN_WARNINGS=$((PLUGIN_WARNINGS + 1))
        # Only add non-conflicting keys
        PLUGIN_ENV=$(jq -n --argjson existing "$PLUGIN_ENV" --argjson new "$MANIFEST_ENV" '
            $existing + ($new | to_entries | map(select(.key as $k | $existing | has($k) | not)) | from_entries)
        ' 2>/dev/null || echo "$PLUGIN_ENV")
    else
        PLUGIN_ENV=$(jq -n --argjson existing "$PLUGIN_ENV" --argjson new "$MANIFEST_ENV" '
            $existing + $new
        ' 2>/dev/null || echo "$PLUGIN_ENV")
    fi

    # Apply config.json overrides (always take precedence)
    if [ -f "$CONFIG_FILE" ]; then
        CONFIG_ENV_OVERRIDES=$(jq -r --arg name "$plugin_name" '.plugins[$name].env // {}' "$CONFIG_FILE" 2>/dev/null || echo "{}")
        if [ "$CONFIG_ENV_OVERRIDES" != "{}" ]; then
            PLUGIN_ENV=$(jq -n --argjson existing "$PLUGIN_ENV" --argjson overrides "$CONFIG_ENV_OVERRIDES" '
                $existing * $overrides
            ' 2>/dev/null || echo "$PLUGIN_ENV")
        fi
    fi
fi
```

**Per-plugin detail log** (per user decision LOCKED):

After all file copies and accumulation for a plugin, log what was installed:
```bash
detail_parts=()
[ "${plugin_skills:-0}" -gt 0 ] && detail_parts+=("${plugin_skills} skill(s)")
[ "${plugin_hooks_count:-0}" -gt 0 ] && detail_parts+=("${plugin_hooks_count} hook(s)")
[ "${plugin_cmds:-0}" -gt 0 ] && detail_parts+=("${plugin_cmds} command(s)")
[ "${plugin_agents:-0}" -gt 0 ] && detail_parts+=("${plugin_agents} agent(s)")

# Count env vars from this plugin's manifest
plugin_env_count=$(jq -r '.env // {} | length' "$MANIFEST" 2>/dev/null || echo "0")
[ "$plugin_env_count" -gt 0 ] && detail_parts+=("${plugin_env_count} env var(s)")

detail_str=$(IFS=", "; echo "${detail_parts[*]}")
if [ -n "$detail_str" ]; then
    echo "[install] Plugin '$plugin_name': installed ($detail_str)"
else
    echo "[install] Plugin '$plugin_name': installed (manifest only)"
fi
PLUGIN_INSTALLED=$((PLUGIN_INSTALLED + 1))
```

Reset per-plugin counters at the start of each plugin iteration:
```bash
plugin_skills=0
plugin_hooks_count=0
plugin_cmds=0
plugin_agents=0
```

**After the plugin loop closes (`done` + `fi`):**

Log a brief line: `echo "[install] Plugins: $PLUGIN_INSTALLED installed, $PLUGIN_SKIPPED skipped"`

Handle the `COPY-06` requirement (empty directories, missing subdirectories) by:
- Using `[ -d ... ]` checks before each copy operation
- Using `[ -f "$file" ] || continue` guards inside loops
- Using `2>/dev/null || true` on cp -r operations
  </action>
  <verify>
Run: `bash -n .devcontainer/install-agent-config.sh` to verify no syntax errors.
Grep for "gsd-" to confirm GSD agent protection regex.
Grep for "commands/gsd" to confirm GSD commands directory protection.
Grep for "PLUGIN_HOOKS" to confirm hook accumulation.
Grep for "PLUGIN_ENV" to confirm env accumulation.
Grep for "detail_parts" to confirm per-plugin logging.
  </verify>
  <done>
- Plugin skills copied to ~/.claude/skills/ and ~/.codex/skills/ (COPY-01, cross-agent)
- Plugin hooks copied to ~/.claude/hooks/ (COPY-02)
- Plugin commands copied to ~/.claude/commands/ (COPY-03)
- Plugin agents copied to ~/.claude/agents/ (COPY-04)
- GSD agents (gsd-*.md) and commands (gsd/) are never overwritten (COPY-05)
- Empty directories and missing subdirectories handled gracefully (COPY-06)
- Hook registrations accumulated using jq array concatenation (HOOK-04 foundation)
- Env vars accumulated with conflict detection (ENV-03 foundation)
- Per-plugin detail logging shows what was installed
- Script passes bash syntax check
  </done>
</task>

</tasks>

<verification>
1. `bash -n .devcontainer/install-agent-config.sh` passes (no syntax errors)
2. `grep -c "agent-config/plugins" .devcontainer/install-agent-config.sh` returns 2+ (directory check, loop)
3. `grep "gsd-" .devcontainer/install-agent-config.sh` shows GSD agent protection
4. `grep "commands/gsd" .devcontainer/install-agent-config.sh` shows GSD commands protection
5. `grep "PLUGIN_HOOKS\|PLUGIN_ENV" .devcontainer/install-agent-config.sh` shows accumulator usage
6. `grep "manifest_name.*plugin_name" .devcontainer/install-agent-config.sh` shows name validation
7. `grep "detail_parts" .devcontainer/install-agent-config.sh` shows per-plugin logging
</verification>

<success_criteria>
- PLUG-01: Plugin directories under agent-config/plugins/ are discovered
- PLUG-02: plugin.json validated for existence and valid JSON
- PLUG-03: Missing plugin.json causes skip with info message
- PLUG-04: Plugins not in config.json are enabled by default
- PLUG-05: Disabled plugins are fully skipped
- PLUG-06: Plugins processed in deterministic alphabetical order
- COPY-01 through COPY-06: All file copying requirements met with GSD protection
- Hook and env accumulation ready for Plan 03 merging
- Per-plugin detail logging implemented
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-plugin-system/04-02-SUMMARY.md`
</output>
