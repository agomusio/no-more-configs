---
phase: 04-core-plugin-system
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - .devcontainer/install-agent-config.sh
autonomous: true

must_haves:
  truths:
    - "Plugin hooks from plugin.json manifests are merged into settings.local.json"
    - "Multiple plugins registering the same hook event all fire (hooks accumulate, not overwrite)"
    - "Template hooks from settings.json.template are preserved when plugin hooks merge"
    - "Hook merge uses jq array concatenation (+ operator) not object merge (* operator)"
    - "Plugin env vars from plugin.json are injected into settings.local.json env section"
    - "config.json plugin env overrides take precedence over plugin.json defaults"
    - "Env vars from multiple plugins are accumulated correctly"
    - "Install summary shows plugin count, hook registrations, command count, and warnings"
  artifacts:
    - path: ".devcontainer/install-agent-config.sh"
      provides: "Plugin hook merging, env var merging, updated install summary"
      contains: "PLUGIN_HOOKS"
  key_links:
    - from: ".devcontainer/install-agent-config.sh"
      to: "~/.claude/settings.local.json"
      via: "jq merge of PLUGIN_HOOKS into .hooks and PLUGIN_ENV into .env"
      pattern: "settings.local.json.*PLUGIN_HOOKS|settings.local.json.*PLUGIN_ENV"
---

<objective>
Merge accumulated plugin hook and environment variable registrations into settings.local.json, and update the install summary.

Purpose: After the plugin loop (Plan 02) accumulates hook registrations and environment variables from all enabled plugins, this plan writes them into `settings.local.json`. It also updates the install summary to include plugin system information. This completes the Phase 4 core plugin functionality.

Output: Updated `install-agent-config.sh` with hook/env merging and comprehensive install summary.
</objective>

<execution_context>
@/home/node/.claude/get-shit-done/workflows/execute-plan.md
@/home/node/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-core-plugin-system/04-CONTEXT.md
@.planning/phases/04-core-plugin-system/04-RESEARCH.md
@.planning/phases/04-core-plugin-system/04-02-SUMMARY.md
@.devcontainer/install-agent-config.sh
@agent-config/settings.json.template
</context>

<tasks>

<task type="auto">
  <name>Task 1: Merge plugin hooks and env vars into settings.local.json</name>
  <files>.devcontainer/install-agent-config.sh</files>
  <action>
Add hook and env var merging sections AFTER the plugin loop's closing `fi` (from Plan 02) and BEFORE credential restoration. The merging must happen after settings.local.json has been generated from the template (which happens earlier in the script).

**1. Merge plugin hooks into settings.local.json (HOOK-01, HOOK-02, HOOK-03, HOOK-04):**

Insert after the plugin loop:
```bash
# --- Merge Plugin Registrations ---

# Merge plugin hooks into settings.local.json
if [ "$PLUGIN_HOOKS" != "{}" ]; then
    SETTINGS_FILE="$CLAUDE_DIR/settings.local.json"
    if [ -f "$SETTINGS_FILE" ]; then
        # Merge plugin hooks with existing template hooks
        # Uses array concatenation (+) to ACCUMULATE hooks, not overwrite
        # Template hooks (e.g., langfuse Stop hook) are preserved
        # Plugin hooks are wrapped in {hooks: [...]} objects and appended to each event array
        jq --argjson plugin_hooks "$PLUGIN_HOOKS" '
            # For each event in plugin_hooks, append new hook entries to existing array
            reduce ($plugin_hooks | to_entries[]) as $entry (.;
                .hooks[$entry.key] = ((.hooks[$entry.key] // []) + [{"hooks": $entry.value}])
            )
        ' "$SETTINGS_FILE" > "$SETTINGS_FILE.tmp" \
            && mv "$SETTINGS_FILE.tmp" "$SETTINGS_FILE"
        echo "[install] Merged plugin hooks into settings.local.json"
    fi
fi
```

**Critical details for hook merging:**
- The settings.local.json hooks structure is: `.hooks.EventName[]` where each element is `{"hooks": [{"type": "command", "command": "..."}]}`
- Template hooks (from settings.json.template hydration) are already in this format
- Plugin hooks from plugin.json have format: `"Stop": [{"type": "command", "command": "..."}]`
- The merge wraps each plugin's hook array in `{"hooks": [...]}` and appends to the event's array
- This uses jq `+` for array concatenation (HOOK-04), NOT `*` which would overwrite
- Existing template hooks are preserved because we concatenate, not replace (HOOK-03)
- Multiple plugins registering the same event accumulate correctly (HOOK-02)
- Use atomic temp file + mv pattern (existing script pattern)

**2. Merge plugin env vars into settings.local.json (ENV-01, ENV-02, ENV-03):**

```bash
# Merge plugin env vars into settings.local.json
if [ "$PLUGIN_ENV" != "{}" ]; then
    SETTINGS_FILE="$CLAUDE_DIR/settings.local.json"
    if [ -f "$SETTINGS_FILE" ]; then
        # Plugin env vars are added to the .env section
        # Existing template env vars are preserved (plugin env uses + which adds new keys)
        # config.json overrides were already applied during accumulation (Plan 02)
        jq --argjson plugin_env "$PLUGIN_ENV" '.env += $plugin_env' \
            "$SETTINGS_FILE" > "$SETTINGS_FILE.tmp" \
            && mv "$SETTINGS_FILE.tmp" "$SETTINGS_FILE"
        echo "[install] Merged plugin env vars into settings.local.json"
    fi
fi
```

**Critical details for env merging:**
- The `+=` operator adds new keys and overwrites existing keys with same name
- Template env vars (LANGFUSE_HOST, etc.) from settings.json.template may overlap with plugin env
- This is intentional: plugin env vars extend the template's env section
- config.json overrides were already applied during accumulation in the plugin loop (Plan 02)
- ENV-02 (config.json precedence) is handled by the accumulation logic, not at merge time

**Placement in script:** These merge sections go BETWEEN the plugin loop's closing `fi` and the credential restoration section. The exact location is: after `echo "[install] Plugins: $PLUGIN_INSTALLED installed, $PLUGIN_SKIPPED skipped"` and before `# Restore Claude credentials`.
  </action>
  <verify>
Run: `bash -n .devcontainer/install-agent-config.sh` to verify no syntax errors.
Grep for "PLUGIN_HOOKS" near "settings.local.json" to confirm hook merge section.
Grep for "PLUGIN_ENV" near "settings.local.json" to confirm env merge section.
Grep for "settings.local.json.tmp" to confirm atomic file update pattern.
Verify the jq hook merge uses array concatenation (look for `+` not `*` in the hook merge jq expression).
  </verify>
  <done>
- Plugin hooks merged into settings.local.json using array concatenation (HOOK-01, HOOK-04)
- Multiple plugins' hooks for same event accumulate correctly (HOOK-02)
- Template hooks preserved during merge (HOOK-03)
- Plugin env vars injected into settings.local.json .env section (ENV-01)
- config.json overrides take precedence (ENV-02 â€” handled in accumulation)
- Multi-plugin env vars accumulated correctly (ENV-03)
- Atomic file updates with temp file + mv pattern
  </done>
</task>

<task type="auto">
  <name>Task 2: Update install summary with plugin system information</name>
  <files>.devcontainer/install-agent-config.sh</files>
  <action>
Update the install summary section at the end of `install-agent-config.sh` to include plugin system information.

**1. Add plugin recap block BEFORE the summary section:**

Insert a plugin recap block after the plugin merging and before the `# Print summary` section. This gives an "at a glance" view per user decision (LOCKED):

```bash
# Plugin installation recap
if [ "$PLUGIN_INSTALLED" -gt 0 ] || [ "$PLUGIN_SKIPPED" -gt 0 ]; then
    echo "[install] --- Plugin Recap ---"
    echo "[install] Plugins: $PLUGIN_INSTALLED installed, $PLUGIN_SKIPPED skipped"

    # Count total hook registrations
    TOTAL_HOOK_REGS=0
    if [ "$PLUGIN_HOOKS" != "{}" ]; then
        TOTAL_HOOK_REGS=$(echo "$PLUGIN_HOOKS" | jq '[.[] | length] | add // 0' 2>/dev/null || echo "0")
    fi
    echo "[install] Hook registrations: $TOTAL_HOOK_REGS"

    # Count total plugin env vars
    TOTAL_PLUGIN_ENV=0
    if [ "$PLUGIN_ENV" != "{}" ]; then
        TOTAL_PLUGIN_ENV=$(echo "$PLUGIN_ENV" | jq 'length' 2>/dev/null || echo "0")
    fi
    echo "[install] Plugin env vars: $TOTAL_PLUGIN_ENV"

    if [ "$PLUGIN_WARNINGS" -gt 0 ]; then
        echo "[install] Warnings: $PLUGIN_WARNINGS"
    fi
fi
```

**2. Update the final summary block:**

In the existing `# Print summary` section, add plugin-related lines. The summary should now include:
```bash
echo "[install] Commands: $COMMANDS_COUNT standalone command(s)"
echo "[install] Plugins: $PLUGIN_INSTALLED installed, $PLUGIN_SKIPPED skipped"
```

Insert these lines in the summary block between the existing Skills/Hooks lines and the MCP line. The full updated summary should read (approximately):
```
[install] --- Summary ---
[install] Config: ...
[install] Secrets: ...
[install] Settings: generated
[install] Credentials (Claude): ...
[install] Credentials (Codex): ...
[install] Git identity: ...
[install] Skills: N skill(s) -> Claude + Codex
[install] Hooks: N hook(s)
[install] Commands: N standalone command(s)
[install] Plugins: N installed, N skipped
[install] MCP: N server(s)
[install] Infra .env: ...
[install] GSD: N commands + N agents
[install] Done.
```

The recap block provides detailed plugin breakdown. The summary provides the one-line overview. Both are needed per user decision.

**Note:** The `COMMANDS_COUNT` line was added in Plan 01. If Plan 01's summary line differs from what's shown here, match the actual Plan 01 output format.
  </action>
  <verify>
Run: `bash -n .devcontainer/install-agent-config.sh` to verify no syntax errors.
Grep for "Plugin Recap" to confirm recap block exists.
Grep for "Hook registrations" to confirm hook count in recap.
Grep for "Plugin env vars" to confirm env count in recap.
Grep for "PLUGIN_INSTALLED\|PLUGIN_SKIPPED" in the summary section.
  </verify>
  <done>
- Plugin recap block shows installed/skipped count, hook registrations, env vars, warnings
- Install summary includes plugins line and commands line
- Summary output matches existing [install] prefix style
- All counters properly referenced in summary
- Script passes bash syntax check
  </done>
</task>

</tasks>

<verification>
1. `bash -n .devcontainer/install-agent-config.sh` passes (no syntax errors)
2. `grep "Plugin Recap" .devcontainer/install-agent-config.sh` shows recap block
3. `grep "Hook registrations" .devcontainer/install-agent-config.sh` shows hook count reporting
4. `grep "PLUGIN_HOOKS.*settings.local" .devcontainer/install-agent-config.sh` shows hook merge
5. `grep "PLUGIN_ENV.*settings.local" .devcontainer/install-agent-config.sh` or grep nearby shows env merge
6. `grep -c "settings.local.json.tmp" .devcontainer/install-agent-config.sh` returns 2+ (hook merge + env merge)
7. The jq hook merge expression uses `+` for array concatenation, not `*`
</verification>

<success_criteria>
- HOOK-01: Plugin hooks from plugin.json merged into settings.local.json
- HOOK-02: Multiple plugins' hooks for same event all accumulate (none lost)
- HOOK-03: Template hooks preserved during plugin hook merge
- HOOK-04: Hook merge uses jq array concatenation (+ not *)
- ENV-01: Plugin env vars injected into settings.local.json env section
- ENV-02: config.json plugin env overrides take precedence
- ENV-03: Env vars from multiple plugins accumulated correctly
- Install summary includes plugin count, hook count, command count, warnings
- Plugin recap block provides at-a-glance plugin installation view
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-plugin-system/04-03-SUMMARY.md`
</output>
