# Project Research Summary

**Project:** Claude Code Sandbox Devcontainer v1 Refactor
**Domain:** Devcontainer Configuration Management for Multi-Agent AI Coding
**Researched:** 2026-02-14
**Confidence:** MEDIUM

## Executive Summary

This project refactors the Claude Code Sandbox devcontainer to eliminate configuration scatter, resolve bind-mount path issues, and prepare for multi-agent support. The current architecture suffers from six-plus scattered config files, Windows path translation problems from bind-mounting `~/.claude`, and non-idempotent setup scripts that fail on rebuild. Research identifies a clear path forward: consolidate configuration into `config.json` (committed structure) + `secrets.json` (gitignored credentials), dissolve the `claudehome/` directory, and implement template-based config generation via `install-agent-config.sh`.

The recommended architecture follows a **Source-of-Truth → Template Hydration → Runtime Config** pattern where user-facing declarative JSON files drive automated generation of runtime configurations. This eliminates bind-mount path mismatches, enables reproducible setups across team members, and provides namespace separation for future multi-agent expansion (Codex CLI, Gemini CLI). The critical insight is separating user-edited source files (version-controlled templates with placeholders) from service-consumed runtime configs (generated, never manually edited).

Key risks center on credential persistence during bind-mount removal, path reference breakage during directory restructuring, and maintaining buildability across refactor commits. Mitigation requires careful phasing: establish infrastructure secrets first, add environment variable indirection before moving files, make scripts idempotent before adding config generation logic, and follow add-wire-delete ordering to keep every commit buildable.

## Key Findings

### Configuration Architecture

**Recommended pattern from ARCHITECTURE.md:**

The system should use a three-layer architecture:

1. **Source of Truth (user-facing, version-controlled):**
   - `config.json` — non-secret configuration (firewall domains, MCP server definitions, project paths, agent preferences)
   - `secrets.json` — credentials only (gitignored, Claude auth, API keys, Langfuse secrets, MCP tokens)
   - `agent-config/` — behavior templates (skills, hooks, commands, settings template with {{PLACEHOLDERS}})

2. **Hydration Layer (postCreateCommand):**
   - `install-agent-config.sh` orchestrates generation
   - Reads config.json + secrets.json into memory
   - Hydrates templates by replacing {{KEY}} placeholders with values
   - Generates derived configs (firewall-domains.conf, .vscode/settings.json, infra/mcp/mcp.json)
   - Copies static assets (skills, hooks, commands)

3. **Runtime Config (service-consumable, never user-edited):**
   - `~/.claude/settings.json` — hydrated from template
   - `.devcontainer/firewall-domains.conf` — generated from config.firewall.extra_domains
   - `/workspace/.mcp.json` — generated by mcp-setup (gitignored)
   - `infra/.env` — infrastructure secrets (separate subsystem)

**Critical separation:** Infrastructure secrets (Postgres passwords, encryption keys) are managed independently via `infra/scripts/generate-env.sh` and never touch `config.json`/`secrets.json`. Agent secrets (API keys for external services) live in `secrets.json`.

### Expected Features

**Must have (table stakes from FEATURES.md):**

- **Idempotent setup scripts** — Rebuilds/restarts must not fail (check state before acting)
- **Single-file agent config source** — All agent settings in `config.json` + `secrets.json` (no scatter)
- **Containerized secrets management** — Separate `secrets.json` (gitignored) from `config.json` (committed)
- **Automated config generation** — `install-agent-config.sh` runs on postCreateCommand
- **Environment variable injection** — `containerEnv` sources from config files
- **Lifecycle hook ordering** — Firewall → Git config → Network checks → Agent setup (no race conditions)
- **Volume persistence for state** — Agent history/sessions/logs survive rebuilds

**Should have (competitive differentiators):**

- **Version-controlled config templates** — `agent-config/` directory enables reproducible setups
- **Single directory dissolution** — Eliminate `claudehome/` scatter (6+ files → 2 files)
- **Multi-agent orchestration ready** — Namespace separation for Claude/Codex/Gemini (v2 scope)
- **Config validation pre-startup** — Catch missing secrets/malformed JSON before agent launch
- **Centralized MCP configuration** — Single `.mcp.json` gateway shared across agents

**Defer to v2+:**

- Multi-agent CLI wrapper (`agent start <claude|codex|gemini>`)
- Save/restore credential workflows (profile switching)
- Firewall domain auto-refresh (CDN IP rotation)
- Agent-specific override support (per-project settings)

### Critical Pitfalls

**From PITFALLS.md, top 5 risks:**

1. **Bind mount removal without secret persistence** — Removing `~/.claude` bind mount loses auth tokens on rebuild. Must implement `secrets.json` + named volumes BEFORE removing mount. Use save-secrets helper to capture live credentials.

2. **Hard-coded path references** — Scripts contain `/workspace/claudehome` paths that break when directory dissolved. Add environment variable indirection (`LANGFUSE_STACK_DIR`, `CLAUDE_WORKSPACE`) BEFORE moving files. Update aliases to use `${VAR:-default}` patterns.

3. **GSD framework can't find `.planning/` from subdirectories** — Framework assumes `.planning/` in current directory. Needs upward traversal to git root. Fix discovery logic before testing from `gitprojects/*` subdirectories.

4. **Non-idempotent install scripts** — `postStartCommand` runs on every VS Code reconnect. Scripts that append to files (`.bashrc` aliases) create duplicates. Add state markers (`~/.local/state/gsd-initialized`) and check-before-append guards.

5. **Commit ordering breaks buildability** — Delete-then-add approach makes intermediate commits unbuildable. Use add-wire-delete ordering: create new structure → update references → test dual-path support → remove old structure.

**Additional warnings:**

- WSL2 path translation issues with bind mounts (Windows `C:\` vs Linux `/mnt/c/`)
- Secrets in containerEnv visible in `docker inspect` (use secrets files instead)
- Generated configs (.mcp.json) accidentally committed (defensive .gitignore patterns)
- Shell aliases not available in non-interactive scripts (convert to functions or PATH commands)

## Implications for Roadmap

Based on combined research, the refactor naturally decomposes into three sequential phases with clear dependency ordering.

### Phase 1: Configuration Consolidation & Secret Isolation

**Rationale:** Must establish secure config foundation before dissolving directory structure. Bind-mount removal requires credential persistence strategy. Non-idempotent scripts must be fixed before adding config generation logic.

**Delivers:**
- `config.json` + `secrets.json` created with schema definitions
- `install-agent-config.sh` orchestration script (idempotent, reads both files)
- Template hydration working ({{PLACEHOLDER}} replacement via sed/jq)
- Infrastructure secrets separated (`infra/.env` generation independent)
- All lifecycle scripts idempotent (state markers, check-before-append)
- `.gitignore` updated for generated files

**Addresses features:**
- Containerized secrets management (secrets.json gitignored)
- Single-file agent config source (config.json structure)
- Automated config generation (install script framework)
- Idempotent setup scripts (state markers)

**Avoids pitfalls:**
- Bind mount removal without persistence (#1)
- Non-idempotent scripts (#4)
- Secrets in environment variables (#7 from PITFALLS)
- Generated configs committed (#8)

**Research flags:** SKIP — Standard config management patterns, well-documented.

---

### Phase 2: Directory Dissolution & Path Resolution

**Rationale:** With config foundation in place, safe to restructure directories. Environment variable indirection must exist before moving files. Commit ordering critical (add-wire-delete).

**Delivers:**
- `claudehome/` dissolved (content redistributed)
- `langfuse-local/` → `infra/langfuse/`
- `agent-config/` created (skills, hooks, commands, settings template)
- `gitprojects/` separation maintained
- Environment variables added (`LANGFUSE_STACK_DIR`, `CLAUDE_WORKSPACE`)
- All path references use env vars (aliases, scripts)
- Dual-path fallback during transition
- GSD framework upward traversal fixed (find .planning/ from subdirs)

**Addresses features:**
- Single directory dissolution (scatter elimination)
- Version-controlled config templates (agent-config/)
- Workspace-relative launches (env var flexibility)

**Avoids pitfalls:**
- Hard-coded path references (#2)
- GSD can't find .planning/ from subdirectories (#3)
- Commit ordering breaks buildability (#5)

**Research flags:** SKIP — Bash scripting and path resolution are standard patterns.

---

### Phase 3: Runtime Config Generation & Validation

**Rationale:** Infrastructure now clean; can implement full config automation. Template generation working; extend to all derived configs. Validation catches errors before first launch.

**Delivers:**
- `firewall-domains.conf` generated from `config.firewall.extra_domains`
- `.vscode/settings.json` generated from `config.projects[]`
- `infra/mcp/mcp.json` generated with hydrated secrets
- `~/.claude/settings.json` hydrated from template
- Config validation script (`validate-config.sh` in postCreateCommand)
- MCP setup auto-runs (postStartCommand)
- Bind mount removed, replaced with named volume
- Save-secrets helper implemented (capture credentials back to secrets.json)

**Addresses features:**
- Automated config generation (complete implementation)
- Config validation pre-startup (validate-config.sh)
- Centralized MCP configuration (.mcp.json generation)
- Lifecycle hook ordering (dependencies verified)
- Volume persistence for state (named volumes)

**Avoids pitfalls:**
- WSL2 path translation (#6)
- Firewall runs before Docker socket ready (#10 from PITFALLS)

**Research flags:** SKIP — Config generation and validation are well-understood patterns.

---

### Phase Ordering Rationale

**Why this sequence:**

1. **Config first** — Can't remove bind mount until secret persistence exists. Can't generate configs until source-of-truth files established. Foundation must be solid before restructuring.

2. **Paths second** — Can't move directories until path references decoupled via env vars. Can't test from subdirectories until GSD discovery fixed. Structure changes require safe reference layer.

3. **Generation last** — Can't auto-generate configs until templates exist. Can't validate until schema defined. Automation builds on established infrastructure.

**Dependency chain from ARCHITECTURE.md:**
```
[Containerized secrets management]
  → [Single-file agent config source]
  → [Automated config generation]
  → [Template hydration]
  → [Runtime config files]
  → [Service startup]
```

**Pitfall avoidance from PITFALLS.md:**
- Phase 1 prevents credential loss (#1) and script duplication (#4)
- Phase 2 prevents path breakage (#2) and commit unbuildability (#5)
- Phase 3 prevents bind mount issues (#6) and race conditions (#10)

**Each phase delivers value independently:**
- Phase 1: Config/secrets separation usable immediately
- Phase 2: Clean directory structure improves maintainability
- Phase 3: Full automation reduces manual steps

### Research Flags

**All phases use standard patterns (skip `/gsd:research-phase`):**

- **Phase 1:** Config file management, template engines, idempotent scripting are well-documented patterns
- **Phase 2:** Directory restructuring, environment variable patterns, git refactoring are standard practices
- **Phase 3:** Config generation, schema validation, Docker volumes are established techniques

**Confidence rationale:** All patterns identified in research have clear implementations in existing scripts (init-firewall.sh, mcp-setup, setup-container.sh). No novel integrations or niche domains requiring deeper research.

**Validation during execution (not pre-research):**
- Verify Claude Code config file paths (~/.claude/settings.json location)
- Test WSL2 path translation with named volumes
- Validate template hydration handles missing keys gracefully

## Confidence Assessment

| Area | Confidence | Notes |
|------|------------|-------|
| Stack | N/A | STACK.md not available (research file missing) |
| Features | MEDIUM | Based on project context analysis and devcontainer best practices; external sources unavailable (WebSearch/WebFetch restricted) |
| Architecture | MEDIUM | Existing codebase provides high-confidence patterns; devcontainer lifecycle hooks from training data |
| Pitfalls | MEDIUM | Codebase analysis reveals specific issues; general pitfall patterns from training data |

**Overall confidence:** MEDIUM

**Reasoning:**
- HIGH confidence in architectural patterns (direct codebase analysis of existing scripts)
- MEDIUM confidence in feature landscape (inferred from project context, no external validation)
- MEDIUM confidence in pitfalls (identified from code but WSL2/Docker Desktop specifics may have changed)
- MISSING stack research (STACK.md unavailable, no technology recommendations)

### Gaps to Address

**During planning/execution:**

1. **Stack selection missing** — No STACK.md available. Assume continuation of existing stack (Debian-based devcontainer, bash scripting, jq/sed for JSON manipulation, Docker Compose for infra). Validate during Phase 1 if alternative tools needed.

2. **Claude Code config schema** — LOW confidence in exact settings.json structure. Verify official docs during Phase 1 when implementing template. Existing scripts provide hints (~/.claude/ locations).

3. **Multi-agent specifics** — v2 scope (Codex CLI, Gemini CLI) deferred but architecture prepared for it. Will need research during v2 planning for agent-specific config requirements.

4. **WSL2 path translation edge cases** — MEDIUM confidence that named volumes resolve issues. Test thoroughly on Windows 11 + WSL2 + Docker Desktop during Phase 3.

5. **GSD framework internals** — Assumed standard path traversal. If custom implementation, may need source code review during Phase 2.

**Acceptable to defer:**
- External validation of devcontainer best practices (2025-2026 spec changes)
- Secret manager integrations (Vault, AWS Secrets Manager) — file-based sufficient for single-user
- Advanced MCP gateway behavior under concurrent agent load — not needed until v2 multi-agent

## Sources

### Primary (HIGH confidence)

**Codebase Analysis:**
- `/c/Users/sam/Dev-Projects/claude-code-sandbox/.devcontainer/devcontainer.json` — Current configuration structure, bind mount patterns, lifecycle hooks
- `/c/Users/sam/Dev-Projects/claude-code-sandbox/.devcontainer/setup-container.sh` — Existing setup patterns, Docker socket permissions
- `/c/Users/sam/Dev-Projects/claude-code-sandbox/.devcontainer/init-firewall.sh` — Firewall initialization sequence
- `/c/Users/sam/Dev-Projects/claude-code-sandbox/.devcontainer/mcp-setup-bin.sh` — MCP configuration generation patterns

**Research Files:**
- `.planning/research/FEATURES.md` — Feature landscape with pain point mapping
- `.planning/research/ARCHITECTURE.md` — Architecture patterns and component boundaries
- `.planning/research/PITFALLS.md` — Critical pitfalls and anti-patterns

### Secondary (MEDIUM confidence)

**Training Data Domains:**
- Devcontainer specification (lifecycle hooks, mounts, environment variables)
- Docker best practices (volumes vs bind mounts, secret management)
- Shell scripting patterns (idempotency, state markers, template engines)
- Multi-agent configuration patterns (namespace separation, config layering)

### Tertiary (LOW confidence, needs validation)

**Inferred from Context:**
- Claude Code CLI configuration file locations (~/.claude/settings.json)
- Codex CLI and Gemini CLI config requirements (assumed similar to Claude Code)
- MCP gateway multiplexing behavior with concurrent agents
- Docker Desktop WSL2 integration specifics for Windows 11 (2026 behavior)

**External Sources Unavailable:**
- WebSearch and WebFetch tools restricted during research
- Official Claude Code documentation (config schema, auth token storage)
- VS Code devcontainer specification updates (2025-2026)
- Docker Desktop release notes (WSL2 path translation changes)

---

*Research completed: 2026-02-14*
*Ready for roadmap: yes*
*Missing STACK.md: assume existing stack continuation*
