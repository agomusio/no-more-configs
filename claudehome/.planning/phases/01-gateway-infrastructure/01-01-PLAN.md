---
phase: 01-gateway-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - langfuse-local/mcp/mcp.json
  - langfuse-local/docker-compose.yml
  - langfuse-local/.env
  - langfuse-local/.env.example

autonomous: true

must_haves:
  truths:
    - "MCP gateway service is defined in docker-compose.yml as a sidecar alongside existing Langfuse services"
    - "Gateway binds to 127.0.0.1:8811 only, not 0.0.0.0"
    - "Filesystem MCP server is configured in mcp.json with stdio transport via npx"
    - "Health check endpoint is configured with adequate start_period for npx download"
    - "Docker socket is NOT mounted in the default gateway service"
    - "Docker socket access is gated behind disabled-by-default mcp-docker-tools compose profile"
    - "MCP_WORKSPACE_BIND environment variable drives workspace mount path"
    - "No port conflicts with existing Langfuse services (3030, 3052, 5433, 6379, 8124, 9000, 9090, 9091)"
  artifacts:
    - path: "langfuse-local/mcp/mcp.json"
      provides: "Filesystem MCP server configuration for gateway"
      contains: "mcpServers"
    - path: "langfuse-local/docker-compose.yml"
      provides: "Gateway sidecar service definition with security hardening"
      contains: "docker-mcp-gateway"
    - path: "langfuse-local/.env"
      provides: "MCP_WORKSPACE_BIND variable for workspace mount"
      contains: "MCP_WORKSPACE_BIND"
    - path: "langfuse-local/.env.example"
      provides: "Documented MCP_WORKSPACE_BIND template for new setups"
      contains: "MCP_WORKSPACE_BIND"
  key_links:
    - from: "langfuse-local/docker-compose.yml"
      to: "langfuse-local/mcp/mcp.json"
      via: "volume mount ./mcp/mcp.json:/etc/mcp/mcp.json:ro"
      pattern: "\\./mcp/mcp\\.json:/etc/mcp/mcp\\.json"
    - from: "langfuse-local/docker-compose.yml"
      to: "langfuse-local/.env"
      via: "MCP_WORKSPACE_BIND variable expansion in volume mount"
      pattern: "MCP_WORKSPACE_BIND.*:/workspace"
    - from: "langfuse-local/mcp/mcp.json"
      to: "@modelcontextprotocol/server-filesystem"
      via: "npx command spawning filesystem MCP server"
      pattern: "server-filesystem"
---

<objective>
Add MCP gateway as a secure Docker Compose sidecar service to the existing Langfuse stack, with filesystem MCP server configured and ready to start.

Purpose: Establishes the foundational gateway infrastructure that all subsequent MCP integration depends on. After this plan, `docker compose up` will start the gateway alongside Langfuse services with filesystem access to /workspace.

Output: Gateway service in docker-compose.yml, filesystem MCP config in mcp.json, workspace bind path in .env files.
</objective>

<execution_context>
@/home/node/.claude/get-shit-done/workflows/execute-plan.md
@/home/node/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-gateway-infrastructure/01-RESEARCH.md
@langfuse-local/docker-compose.yml
@langfuse-local/.env.example
@langfuse-local/.env
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MCP gateway config and environment variables</name>
  <files>langfuse-local/mcp/mcp.json, langfuse-local/.env, langfuse-local/.env.example</files>
  <action>
1. Create directory `langfuse-local/mcp/` if it does not exist.

2. Create `langfuse-local/mcp/mcp.json` with this exact content:
```json
{
  "mcpServers": {
    "filesystem": {
      "command": "npx",
      "args": [
        "-y",
        "@modelcontextprotocol/server-filesystem@2026.1.14",
        "/workspace"
      ],
      "env": {}
    }
  }
}
```
Key points:
- Pin to `@2026.1.14` version for reproducibility (per research).
- `-y` flag auto-confirms npx install prompt.
- `/workspace` is the mount point inside the gateway container (must match the volume mount in docker-compose.yml).
- `env` is empty object for filesystem server (no secrets needed). This follows SEC-03 pattern — when future servers need secrets, they go in `env` referencing environment variables, not hardcoded values.

3. Read current `langfuse-local/.env` and append these lines at the end (after existing content, with a blank line separator and comment header):
```
# MCP Gateway Configuration
# Absolute host path to workspace (must be host-daemon-visible, not devcontainer-relative)
# On Windows/WSL: Use the Windows path that Docker Desktop can access
# Example: /home/user/projects/claudehome or /mnt/c/Users/you/projects/claudehome
MCP_WORKSPACE_BIND=/workspace
```
NOTE: The default `/workspace` works because the devcontainer's `workspaceMount` in devcontainer.json already maps the host workspace folder to `/workspace`. The Docker daemon sees this as a bind mount from the actual host path. Since `docker compose` runs on the host daemon and the gateway is a sibling container, the host path for MCP_WORKSPACE_BIND should typically match what the user's host maps to /workspace. However, `/workspace` is a safe default that works when Docker Compose is invoked from within the devcontainer (which has /workspace bind-mounted from host).

4. Read current `langfuse-local/.env.example` and append these lines at the end (matching the .env addition):
```

# MCP Gateway Configuration
# Absolute host path to workspace directory
# Must be the same path Docker daemon uses to mount /workspace in devcontainer
# Example: /home/user/projects/claudehome (Linux) or /mnt/c/Users/you/projects/claudehome (WSL)
MCP_WORKSPACE_BIND=/workspace
```
  </action>
  <verify>
Run these checks:
1. `cat langfuse-local/mcp/mcp.json | python3 -m json.tool` — must parse without errors and show mcpServers.filesystem with npx command
2. `grep MCP_WORKSPACE_BIND langfuse-local/.env` — must show the variable assignment
3. `grep MCP_WORKSPACE_BIND langfuse-local/.env.example` — must show the variable assignment
4. `grep -c "CHANGE_ME\|hardcoded" langfuse-local/mcp/mcp.json` — must return 0 (no hardcoded secrets)
  </verify>
  <done>
mcp.json exists with filesystem MCP server configured via npx stdio transport. MCP_WORKSPACE_BIND is defined in both .env and .env.example with documentation. No secrets are hardcoded in mcp.json.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add MCP gateway sidecar service to Docker Compose</name>
  <files>langfuse-local/docker-compose.yml</files>
  <action>
Read the existing `langfuse-local/docker-compose.yml` and add TWO new services before the `volumes:` section at the bottom.

**Service 1: `docker-mcp-gateway`** (default, always runs):
```yaml
  docker-mcp-gateway:
    image: docker/mcp-gateway:latest
    container_name: docker-mcp-gateway
    restart: unless-stopped
    ports:
      - "127.0.0.1:8811:8811"
    volumes:
      - ./mcp/mcp.json:/etc/mcp/mcp.json:ro
      - ${MCP_WORKSPACE_BIND}:/workspace:rw
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:8811/health"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 20s
```

Key configuration decisions and WHY:
- `127.0.0.1:8811:8811` — Loopback-only binding prevents LAN exposure (SEC-01, INFRA-02). Do NOT use `8811:8811` or `0.0.0.0:8811:8811`.
- `./mcp/mcp.json:/etc/mcp/mcp.json:ro` — Read-only config mount. Gateway reads this to discover MCP servers (INFRA-03).
- `${MCP_WORKSPACE_BIND}:/workspace:rw` — Workspace mount aligned with devcontainer's /workspace (FSMCP-02). :rw required for filesystem write operations.
- `start_period: 20s` — Allows npx to download @modelcontextprotocol/server-filesystem on first run before counting health check failures (INFRA-04).
- `wget` for health check — Alpine-based images include wget; curl may not be available.
- `restart: unless-stopped` — Survives host restart but respects manual stop.
- NO `depends_on` on Langfuse services — gateway is independent; no coupling to Langfuse readiness.
- NO Docker socket mount — security-first default (SEC-02).

**Service 2: `docker-mcp-gateway-with-docker`** (disabled by default, profile-gated):
```yaml
  docker-mcp-gateway-with-docker:
    extends:
      service: docker-mcp-gateway
    volumes:
      - ./mcp/mcp.json:/etc/mcp/mcp.json:ro
      - ${MCP_WORKSPACE_BIND}:/workspace:rw
      - /var/run/docker.sock:/var/run/docker.sock
    profiles:
      - mcp-docker-tools
```

Key points:
- Uses `extends` to inherit all settings from gateway service (image, ports, healthcheck, restart).
- Overrides `volumes` to add Docker socket mount (must redeclare ALL volumes since extends doesn't merge arrays).
- `profiles: ["mcp-docker-tools"]` — Disabled by default. Only starts with `docker compose --profile mcp-docker-tools up` (SEC-02).
- This service is a future hook for Docker-based MCP tools. Phase 1 does NOT enable it.

**Port conflict verification (INFRA-05):**
Existing ports in docker-compose.yml: 3030, 3052, 8124, 9000, 9090, 9091, 6379, 5433.
Gateway port 8811 does NOT conflict with any of these.

**Placement:** Add both services after the `postgres` service and before the `volumes:` section. Maintain consistent 2-space YAML indentation matching the existing file.

Do NOT modify any existing service definitions. Only ADD the two new services.
  </action>
  <verify>
Run these checks:
1. `docker compose -f langfuse-local/docker-compose.yml config --services` — must list `docker-mcp-gateway` alongside existing services (langfuse-worker, langfuse-web, clickhouse, minio, redis, postgres). Must NOT list `docker-mcp-gateway-with-docker` (it is profile-gated).
2. `docker compose -f langfuse-local/docker-compose.yml config` — must parse without YAML errors. Verify the full resolved config shows correct port binding, volume mounts, and health check.
3. `docker compose -f langfuse-local/docker-compose.yml config | grep -A1 "8811"` — must show `127.0.0.1:8811:8811` binding (loopback only).
4. `docker compose -f langfuse-local/docker-compose.yml --profile mcp-docker-tools config --services` — must include `docker-mcp-gateway-with-docker`.
5. Verify no Docker socket in default service: `docker compose -f langfuse-local/docker-compose.yml config | grep -c "docker.sock"` — must return 0 (socket only in profile-gated service).
  </verify>
  <done>
docker-compose.yml contains docker-mcp-gateway service with loopback-only port binding on 8811, health check with 20s start_period, mcp.json volume mount, and workspace mount. Docker socket profile-gated service exists but is disabled by default. No port conflicts with existing services. YAML parses cleanly.
  </done>
</task>

</tasks>

<verification>
Phase 1 requirement coverage verification:

| Requirement | How Covered | Verification |
|-------------|-------------|-------------|
| INFRA-01 | Gateway service in docker-compose.yml | `docker compose config --services` lists docker-mcp-gateway |
| INFRA-02 | `image: docker/mcp-gateway:latest`, `127.0.0.1:8811:8811` | `docker compose config` shows correct image and port |
| INFRA-03 | mcp.json mounted at /etc/mcp/mcp.json:ro | Config file exists, volume mount in compose |
| INFRA-04 | healthcheck with wget, start_period: 20s | `docker compose config` shows health check block |
| INFRA-05 | Port 8811 not in {3030, 3052, 5433, 6379, 8124, 9000, 9090, 9091} | Manual verification of port list |
| FSMCP-01 | mcp.json has filesystem server with npx + stdio transport | `cat mcp.json` shows server config |
| FSMCP-02 | ${MCP_WORKSPACE_BIND}:/workspace:rw volume mount | `docker compose config` shows workspace volume |
| SEC-01 | 127.0.0.1:8811:8811 port binding | `docker compose config` grep for 127.0.0.1 |
| SEC-02 | Profile-gated docker-mcp-gateway-with-docker service | Default config has no docker.sock; profile config has it |
| SEC-03 | mcp.json env:{} is empty; secrets go in compose environment | No hardcoded secrets in mcp.json |
| SEC-04 | Existing firewall allows host.docker.internal traffic | init-firewall.sh already resolves and allows host.docker.internal IP |

Note on SEC-04: The devcontainer's `init-firewall.sh` already resolves `host.docker.internal` and adds iptables rules allowing traffic to that IP. Since the gateway binds to 127.0.0.1:8811 on the host, and the devcontainer reaches it via `host.docker.internal:8811`, the existing firewall rules already permit this traffic. No additional firewall configuration is needed for Phase 1.
</verification>

<success_criteria>
1. `docker compose -f langfuse-local/docker-compose.yml config` parses without errors
2. `docker compose -f langfuse-local/docker-compose.yml config --services` includes docker-mcp-gateway
3. Gateway port binding is 127.0.0.1:8811:8811 (loopback only)
4. mcp.json contains filesystem server configuration with npx stdio transport
5. MCP_WORKSPACE_BIND is defined in .env and .env.example
6. No docker.sock in default service configuration
7. docker-mcp-gateway-with-docker only appears with mcp-docker-tools profile
</success_criteria>

<output>
After completion, create `.planning/phases/01-gateway-infrastructure/01-01-SUMMARY.md`
</output>
