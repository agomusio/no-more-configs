---
phase: 02-connectivity-health-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/verify-gateway-connectivity.sh
  - scripts/verify-filesystem-mcp.sh
autonomous: true

must_haves:
  truths:
    - "Devcontainer can reach gateway health endpoint at host.docker.internal:8811"
    - "Gateway logs are accessible via docker logs docker-mcp-gateway"
    - "File written in devcontainer is readable from gateway container at same /workspace path"
    - "File written from gateway container is readable in devcontainer at same /workspace path"
    - "Health check start_period is >= 20s to account for npx download"
    - "Gateway health status transitions to healthy (not unhealthy) after startup"
  artifacts:
    - path: "scripts/verify-gateway-connectivity.sh"
      provides: "Reusable connectivity and health validation script"
      min_lines: 40
    - path: "scripts/verify-filesystem-mcp.sh"
      provides: "Reusable filesystem MCP cross-container file operations test"
      min_lines: 30
  key_links:
    - from: "devcontainer (this container)"
      to: "docker-mcp-gateway:8811"
      via: "HTTP over host.docker.internal"
      pattern: "curl.*host\\.docker\\.internal:8811"
    - from: "devcontainer /workspace"
      to: "gateway /workspace"
      via: "shared Docker bind mount (MCP_WORKSPACE_BIND)"
      pattern: "same host path for both containers"
---

<objective>
Validate that the MCP gateway deployed in Phase 1 is reachable from the devcontainer, health checks pass with correct timing, gateway logs are accessible, and filesystem MCP operations work end-to-end across containers.

Purpose: Prove the gateway infrastructure actually works from the devcontainer's perspective before wiring it into Claude Code in Phase 3. This is a validation phase -- no new infrastructure, just scripts that exercise and verify what Phase 1 built.

Output: Two reusable validation scripts (connectivity + filesystem MCP) that pass when run from inside the devcontainer, confirming all Phase 2 success criteria.
</objective>

<execution_context>
@/home/node/.claude/get-shit-done/workflows/execute-plan.md
@/home/node/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-gateway-infrastructure/01-01-SUMMARY.md
@.planning/phases/02-connectivity-health-validation/02-RESEARCH.md
@langfuse-local/docker-compose.yml
@langfuse-local/mcp/mcp.json
@.devcontainer/devcontainer.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create and run gateway connectivity and health validation script</name>
  <files>scripts/verify-gateway-connectivity.sh</files>
  <action>
Create `scripts/verify-gateway-connectivity.sh` — a bash script that validates gateway connectivity from inside the devcontainer. This script will be run FROM the devcontainer (where we execute), not from the host.

The script must perform these checks in order:

1. **Gateway container running** — `docker ps --filter name=docker-mcp-gateway --format '{{.Status}}'` shows "Up". If not running, start it with `docker compose -f /workspace/claudehome/langfuse-local/docker-compose.yml up -d docker-mcp-gateway` and wait up to 30s for healthy status.

2. **Health check start_period validation** — `docker inspect docker-mcp-gateway --format='{{.Config.Healthcheck.StartPeriod}}'` returns >= 20000000000 (20s in nanoseconds). This confirms VERIF-02.

3. **Gateway health status** — `docker inspect docker-mcp-gateway --format='{{.State.Health.Status}}'` returns "healthy". If "starting", wait up to 30s polling every 2s. If "unhealthy", print last health check log and exit 1.

4. **HTTP health endpoint from devcontainer** — `curl -sf http://host.docker.internal:8811/health` returns HTTP 200. This is the critical CONN-01 test: can the devcontainer reach the gateway? If curl fails, try fallback: get gateway IP via `docker inspect docker-mcp-gateway -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}'` and curl that IP.

5. **Gateway logs accessible** — `docker logs --tail 5 docker-mcp-gateway` produces output (non-empty). This confirms CONN-03.

6. **Volume mount alignment** — Compare mount sources: `docker inspect docker-mcp-gateway -f '{{range .Mounts}}{{if eq .Destination "/workspace"}}{{.Source}}{{end}}{{end}}'` should match the devcontainer's workspace mount source. Use `docker inspect $(hostname) ...` or discover devcontainer name from `docker ps --filter id=$(hostname)`.

Script should:
- Use `set -euo pipefail`
- Print numbered step output like `[1/6] Checking gateway container...`
- Print clear pass/fail per step with descriptive messages
- Exit 0 on full success, exit 1 on any failure
- Be executable (`chmod +x`)
- Handle the case where gateway needs to be started (auto-start it)

After creating the script, run it. If the gateway is not running, the script should auto-start it. All 6 checks must pass.

Important context:
- We ARE inside the devcontainer. `curl http://host.docker.internal:8811/health` works directly (no docker exec needed).
- `host.docker.internal` is already configured via `--add-host=host.docker.internal:host-gateway` in devcontainer.json runArgs.
- The firewall (init-firewall.sh) allows Docker bridge subnet (172.16.0.0/12) and host.docker.internal traffic.
- Gateway binds to 127.0.0.1:8811 on the host, reachable from devcontainer via host.docker.internal.
  </action>
  <verify>
Run: `bash scripts/verify-gateway-connectivity.sh`
All 6 checks pass (exit code 0). Gateway is running and healthy. HTTP health endpoint returns 200 from devcontainer.
  </verify>
  <done>
Gateway is running, healthy, reachable from devcontainer at host.docker.internal:8811, logs accessible, health check start_period >= 20s, volume mounts aligned.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create and run filesystem MCP cross-container validation script</name>
  <files>scripts/verify-filesystem-mcp.sh</files>
  <action>
Create `scripts/verify-filesystem-mcp.sh` — a bash script that validates filesystem MCP operations work end-to-end across containers. Run FROM devcontainer.

Prerequisites: Gateway must be running and healthy (script should check and fail fast if not).

The script must perform these checks:

1. **Pre-flight: gateway healthy** — `curl -sf http://host.docker.internal:8811/health` returns 200. If not, print "Run verify-gateway-connectivity.sh first" and exit 1.

2. **Devcontainer-to-gateway file visibility** — Write a test file from devcontainer: `echo "written-from-devcontainer-$(date +%s)" > /workspace/claudehome/.mcp-test-dc.txt`. Read it from gateway: `docker exec docker-mcp-gateway cat /workspace/.mcp-test-dc.txt`. Content must match.

IMPORTANT PATH NOTE: The devcontainer mounts the workspace at /workspace, and the docker-compose.yml mounts MCP_WORKSPACE_BIND:/workspace in the gateway. Both see /workspace but the devcontainer's /workspace contains the claudehome directory as a subdirectory (or IS the workspace root). Need to figure out the actual path mapping:
- Devcontainer workspace is at /workspace (workspaceFolder in devcontainer.json)
- Gateway mounts ${MCP_WORKSPACE_BIND}:/workspace
- MCP_WORKSPACE_BIND defaults to /workspace in .env.example

The script should discover the actual mapping by writing to a known path and checking from the other container. Write to /workspace/claudehome/.mcp-test-dc.txt from devcontainer, then check both /workspace/claudehome/.mcp-test-dc.txt AND /workspace/.mcp-test-dc.txt from gateway to find the correct mapping.

3. **Gateway-to-devcontainer file visibility** — Write a test file from gateway: `docker exec docker-mcp-gateway sh -c 'echo "written-from-gateway-TIMESTAMP" > /workspace/mcp-test-gw.txt'`. Read it from devcontainer at the discovered path. Content must match.

4. **Gateway can list workspace directory** — `docker exec docker-mcp-gateway ls /workspace` returns non-empty directory listing. This confirms the volume mount is working and the filesystem MCP server would be able to list files.

5. **Gateway can read arbitrary file** — `docker exec docker-mcp-gateway cat /workspace/<known-file>` returns content (use a file known to exist, like one in the claudehome directory). This validates FSMCP-03 read capability.

6. **Cleanup** — Remove all test files created during validation.

Script should:
- Use `set -euo pipefail`
- Print numbered step output
- Print clear pass/fail with content comparison details on failure
- Exit 0 on success, exit 1 on failure
- Clean up test files even on failure (trap)
- Be executable (`chmod +x`)

After creating the script, run it. All checks must pass.
  </action>
  <verify>
Run: `bash scripts/verify-filesystem-mcp.sh`
All checks pass (exit code 0). Files written from devcontainer are readable from gateway and vice versa. Cleanup completes.
  </verify>
  <done>
Cross-container file operations verified: devcontainer writes are visible in gateway, gateway writes are visible in devcontainer. Volume mount alignment confirmed empirically. FSMCP-03 validated.
  </done>
</task>

</tasks>

<verification>
After both tasks complete, run the full validation suite:

```bash
bash scripts/verify-gateway-connectivity.sh && bash scripts/verify-filesystem-mcp.sh
```

Both scripts must exit 0. Together they prove:
- CONN-01: Gateway reachable from devcontainer via host.docker.internal:8811
- CONN-03: Gateway logs accessible via docker logs
- FSMCP-03: Filesystem MCP can read and write files in /workspace
- VERIF-02: Health check start_period accounts for npx download (>= 20s)

Additionally verify gateway is still healthy after all tests:
```bash
curl -sf http://host.docker.internal:8811/health && echo "Gateway healthy"
```
</verification>

<success_criteria>
1. `scripts/verify-gateway-connectivity.sh` exists and passes all 6 checks when run from devcontainer
2. `scripts/verify-filesystem-mcp.sh` exists and passes all checks when run from devcontainer
3. Gateway container is running with "healthy" status
4. curl to host.docker.internal:8811/health returns 200 from inside devcontainer
5. Files written in devcontainer /workspace are readable from gateway /workspace (and vice versa)
6. Health check start_period is >= 20s (nanosecond check via docker inspect)
7. docker logs docker-mcp-gateway produces non-empty output
</success_criteria>

<output>
After completion, create `.planning/phases/02-connectivity-health-validation/02-01-SUMMARY.md`
</output>
